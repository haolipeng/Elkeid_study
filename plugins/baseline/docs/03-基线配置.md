# Elkeid Baseline 插件 - 基线配置设计

## 目录
- [配置文件结构](#配置文件结构)
- [预定义基线](#预定义基线)
- [检查项分类](#检查项分类)
- [配置示例](#配置示例)
- [自定义基线开发](#自定义基线开发)
- [最佳实践](#最佳实践)

---

## 配置文件结构

### YAML 顶层结构

所有基线配置文件遵循统一的 YAML 结构，位于 `config/linux/` 目录。

**完整结构**:

```yaml
baseline_id: 1200                                    # 基线唯一标识
baseline_version: "1.0"                              # 基线版本
baseline_name: "字节跳动最佳实践-CentOS基线检查"        # 中文名称
baseline_name_en: "ByteDance Standard-CentOS Baseline" # 英文名称

system:                                               # 适用系统列表
  - "centos6"
  - "centos7"
  - "centos8"

check_list:                                           # 检查项列表
  - check_id: 1                                       # 检查项ID
    type: "Identification"                            # 检查类型(英文)
    type_cn: "身份鉴别"                                # 检查类型(中文)
    title: "Ensure password expiration..."            # 标题(英文)
    title_cn: "设置密码失效时间<=90天"                  # 标题(中文)
    description: "The PASS_MAX_DAYS parameter..."     # 描述(英文)
    description_cn: "请设置密码失效时间..."            # 描述(中文)
    solution: "Set the PASS_MAX_DAYS parameter..."    # 解决方案(英文)
    solution_cn: "在 /etc/login.defs 中设置..."        # 解决方案(中文)
    security: "high"                                  # 安全等级

    check:                                            # 检查规则
      condition: "all"                                # 条件逻辑
      rules:                                          # 规则列表
        - type: "file_line_check"                     # 规则类型
          param:                                      # 参数列表
            - "/etc/login.defs"
          filter: 'PASS_MAX_DAYS\s+(\d+)'             # 过滤器(正则)
          result: '$(<=)90'                           # 期望结果
```

### 字段说明

#### 基线元数据

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| baseline_id | int | ✅ | 基线唯一标识，< 6000 为 Linux 基线 |
| baseline_version | string | ✅ | 基线版本号 |
| baseline_name | string | ✅ | 基线名称（中文） |
| baseline_name_en | string | ✅ | 基线名称（英文） |
| system | []string | ✅ | 适用系统列表 |

**baseline_id 分配规则**:
- `1200-1299`: CentOS 系列基线
- `1300-1399`: Debian 系列基线
- `1400-1499`: Ubuntu 系列基线
- `5000-5999`: 跨平台基线（如弱密码检查）
- `6000+`: 容器基线（预留）

#### 检查项元数据

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| check_id | int | ✅ | 检查项唯一ID（在同一基线内） |
| type | string | ✅ | 检查类型（英文） |
| type_cn | string | ✅ | 检查类型（中文） |
| title | string | ✅ | 检查项标题（英文） |
| title_cn | string | ✅ | 检查项标题（中文） |
| description | string | ✅ | 详细描述（英文） |
| description_cn | string | ✅ | 详细描述（中文） |
| solution | string | ✅ | 解决方案（英文） |
| solution_cn | string | ✅ | 解决方案（中文） |
| security | string | ✅ | 安全等级: high/mid/low |

#### 检查规则

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| check.condition | string | ❌ | 条件逻辑: all/any/none（默认 all） |
| check.rules | []Rule | ✅ | 规则列表（至少一条） |

#### 单条规则

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | string | ✅ | 规则类型（见规则引擎文档） |
| param | []string | ✅ | 参数列表 |
| filter | string | ❌ | 过滤器（正则表达式） |
| result | interface{} | ✅ | 期望结果（bool/int/string） |
| require | string | ❌ | 前置条件 |

---

## 预定义基线

### 1200 - CentOS 基线

**文件**: `config/linux/1200.yaml`

**适用系统**: CentOS 6/7/8

**检查项数量**: 约 120 项

**主要检查内容**:
- 密码策略（长度、有效期、复杂度）
- 账户安全（锁定策略、会话超时）
- 文件权限（/etc/shadow, /etc/passwd 等）
- SSH 安全配置
- 系统服务加固
- 审计日志配置

**示例检查项**:

```yaml
# 检查项 1: 密码有效期
- check_id: 1
  type: "Identification"
  title: "Ensure password expiration is 180 days or less"
  title_cn: "设置密码失效时间<=90天"
  security: "high"
  check:
    rules:
      - type: file_line_check
        param: ["/etc/login.defs"]
        filter: 'PASS_MAX_DAYS\s+(\d+)'
        result: '$(<=)90'

# 检查项 2: 密码修改最短周期
- check_id: 2
  type: "Identification"
  title: "Ensure minimum days between password changes is 2 or more"
  title_cn: "密码修改最短周期>=2天"
  security: "high"
  check:
    rules:
      - type: file_line_check
        param: ["/etc/login.defs"]
        filter: 'PASS_MIN_DAYS\s+(\d+)'
        result: '$(>=)2'
```

### 1300 - Debian 基线

**文件**: `config/linux/1300.yaml`

**适用系统**: Debian 8/9/10

**检查项数量**: 约 120 项

**与 CentOS 基线的差异**:
- 部分配置文件路径不同
- 系统服务名称不同（如 `sshd` vs `ssh`）
- 默认软件包不同

### 1400 - Ubuntu 基线

**文件**: `config/linux/1400.yaml`

**适用系统**: Ubuntu 14.04/16.04/18.04/20.04

**检查项数量**: 约 120 项

**特性**:
- 继承 Debian 基线大部分内容
- 针对 Ubuntu 特有配置进行调整
- 支持 Snap/AppArmor 等 Ubuntu 特性

### 5000 - 弱密码基线

**文件**: `config/linux/5000.yaml`

**适用系统**: 跨平台

**检查项数量**: 约 10 项

**主要检查**:
- 空密码账户
- 默认密码
- 弱密码模式
- 密码重用

---

## 检查项分类

### 分类体系

根据等保2.0和CIS Benchmark标准，检查项分为以下类别：

#### 1. 身份鉴别 (Identification)

**关注点**: 用户身份认证机制

**典型检查项**:
- 密码长度策略
- 密码有效期
- 密码复杂度
- 账户锁定策略
- 用户唯一性

**示例**:

```yaml
- check_id: 1
  type: "Identification"
  type_cn: "身份鉴别"
  title_cn: "设置密码失效时间<=90天"
  security: "high"
  check:
    rules:
      - type: file_line_check
        param: ["/etc/login.defs"]
        filter: 'PASS_MAX_DAYS\s+(\d+)'
        result: '$(<=)90'
```

#### 2. 访问控制 (Access Control)

**关注点**: 文件和资源的访问权限

**典型检查项**:
- 敏感文件权限（/etc/shadow, /etc/passwd）
- 配置文件所有者
- 目录权限
- umask 设置

**示例**:

```yaml
- check_id: 50
  type: "Access Control"
  type_cn: "访问控制"
  title_cn: "/etc/shadow 文件权限检查"
  security: "high"
  check:
    rules:
      - type: file_permission
        param: ["/etc/shadow", "600"]
        result: true

      - type: file_user_group
        param: ["/etc/shadow", "0:0"]
        result: true
```

#### 3. 安全审计 (Security Audit)

**关注点**: 日志和审计配置

**典型检查项**:
- 审计日志启用
- 日志保留策略
- 审计规则配置
- 远程日志

**示例**:

```yaml
- check_id: 80
  type: "Security Audit"
  type_cn: "安全审计"
  title_cn: "审计进程启动/停止事件"
  security: "mid"
  check:
    rules:
      - type: file_line_check
        param: ["/etc/audit/rules.d/audit.rules"]
        result: ".*-w /sbin/init.*"
```

#### 4. 入侵防范 (Intrusion Prevention)

**关注点**: 系统安全加固

**典型检查项**:
- SSH 安全配置
- 防火墙规则
- SELinux/AppArmor
- 不必要服务禁用

**示例**:

```yaml
- check_id: 100
  type: "Intrusion Prevention"
  type_cn: "入侵防范"
  title_cn: "禁止SSH root登录"
  security: "high"
  check:
    condition: any
    rules:
      - type: file_line_check
        param: ["/etc/ssh/sshd_config", "PermitRootLogin"]
        result: "$(not).*yes$"

      - type: file_line_check
        param: ["/etc/ssh/sshd_config", "PermitRootLogin"]
        result: ".*prohibit-password.*"
```

#### 5. 资源控制 (Resource Control)

**关注点**: 系统资源限制

**典型检查项**:
- 用户进程数限制
- 文件描述符限制
- 内存限制

**示例**:

```yaml
- check_id: 120
  type: "Resource Control"
  type_cn: "资源控制"
  title_cn: "限制用户最大进程数"
  security: "mid"
  check:
    rules:
      - type: file_line_check
        param: ["/etc/security/limits.conf"]
        result: ".*nproc.*"
```

### 安全等级

| 等级 | 值 | 说明 | 修复优先级 |
|------|-----|------|-----------|
| 高危 | high | 严重安全风险，可能导致系统被攻破 | P0 |
| 中危 | mid | 存在安全隐患，可能被利用 | P1 |
| 低危 | low | 不符合最佳实践，风险较小 | P2 |

---

## 配置示例

### 示例1: 密码策略检查

```yaml
- check_id: 1
  type: "Identification"
  type_cn: "身份鉴别"
  title: "Ensure password expiration is 90 days or less"
  title_cn: "设置密码失效时间<=90天"
  description: "The PASS_MAX_DAYS parameter allows an administrator to force passwords to expire."
  description_cn: "设置密码失效时间，定期修改密码策略，减少密码被泄漏风险。"
  solution: "Set PASS_MAX_DAYS parameter to 90 in /etc/login.defs"
  solution_cn: "在 /etc/login.defs 中将 PASS_MAX_DAYS 参数设置为 90"
  security: "high"
  check:
    condition: "all"
    rules:
      - type: "file_line_check"
        param:
          - "/etc/login.defs"
        filter: '\s*\t*PASS_MAX_DAYS\s*\t*(\d+)'
        result: '$(<=)90'
```

### 示例2: SSH 安全配置

```yaml
- check_id: 10
  type: "Intrusion Prevention"
  type_cn: "入侵防范"
  title: "Ensure SSH root login is disabled"
  title_cn: "禁止SSH root登录"
  description: "Disabling root SSH login helps prevent unauthorized root access."
  description_cn: "禁止root通过SSH登录，防止暴力破解攻击。"
  solution: "Set 'PermitRootLogin no' in /etc/ssh/sshd_config"
  solution_cn: "在 /etc/ssh/sshd_config 中设置 PermitRootLogin no"
  security: "high"
  check:
    condition: "all"
    rules:
      - type: "file_line_check"
        param:
          - "/etc/ssh/sshd_config"
          - "PermitRootLogin"
        result: "$(not).*yes$"
```

### 示例3: 文件权限检查

```yaml
- check_id: 20
  type: "Access Control"
  type_cn: "访问控制"
  title: "Ensure /etc/shadow permissions are 600"
  title_cn: "/etc/shadow 权限检查"
  description: "The /etc/shadow file stores password hashes and must be protected."
  description_cn: "/etc/shadow 存储密码哈希，必须严格限制访问权限。"
  solution: "Run: chmod 600 /etc/shadow && chown root:root /etc/shadow"
  solution_cn: "执行: chmod 600 /etc/shadow && chown root:root /etc/shadow"
  security: "high"
  check:
    condition: "all"
    rules:
      - type: "file_permission"
        param:
          - "/etc/shadow"
          - "600"
        result: true

      - type: "file_user_group"
        param:
          - "/etc/shadow"
          - "0:0"
        result: true
```

### 示例4: 使用 any 条件

```yaml
- check_id: 30
  type: "Identification"
  type_cn: "身份鉴别"
  title: "Ensure password authentication is secure"
  title_cn: "确保密码认证安全"
  description: "Use either public key auth or disable root login."
  description_cn: "使用密钥认证或禁用root登录。"
  solution: "Configure SSH to use public key authentication or disable root login"
  solution_cn: "配置SSH使用密钥认证或禁用root登录"
  security: "mid"
  check:
    condition: "any"  # 满足任意一个即可
    rules:
      - type: "file_line_check"
        param: ["/etc/ssh/sshd_config", "PubkeyAuthentication"]
        result: ".*yes$"

      - type: "file_line_check"
        param: ["/etc/ssh/sshd_config", "PermitRootLogin"]
        result: "$(not).*yes$"
```

### 示例5: 复杂规则组合

```yaml
- check_id: 40
  type: "Access Control"
  type_cn: "访问控制"
  title: "Ensure core dump is restricted"
  title_cn: "限制core dump"
  description: "Core dumps may contain sensitive information."
  description_cn: "Core dump可能包含敏感信息，应限制或禁用。"
  solution: "Configure limits.conf and sysctl.conf"
  solution_cn: "配置 limits.conf 和 sysctl.conf"
  security: "mid"
  check:
    condition: "all"
    rules:
      # 检查 limits.conf
      - type: "file_line_check"
        param: ["/etc/security/limits.conf"]
        result: ".*hard.*core.*0.*"

      # 检查 sysctl.conf
      - type: "file_line_check"
        param: ["/etc/sysctl.conf"]
        filter: 'fs.suid_dumpable\s*=\s*(\d+)'
        result: '0'

      # 检查当前设置
      - type: "command_check"
        param: ["sysctl fs.suid_dumpable"]
        filter: 'fs.suid_dumpable\s*=\s*(\d+)'
        result: '0'
```

### 示例6: 前置条件 (require)

```yaml
- check_id: 50
  type: "Identification"
  type_cn: "身份鉴别"
  title: "Ensure password requirements for SSH"
  title_cn: "SSH密码认证的密码要求"
  description: "If password auth is enabled, ensure strong passwords."
  description_cn: "如果启用了密码认证，确保密码复杂度要求。"
  solution: "Configure PAM password requirements"
  solution_cn: "配置 PAM 密码复杂度要求"
  security: "high"
  check:
    rules:
      - type: "file_line_check"
        param: ["/etc/pam.d/system-auth"]
        require: "allow_ssh_passwd"  # 前置条件: SSH允许密码认证时才检查
        filter: 'pam_pwquality.so.*minlen=(\d+)'
        result: '$(>=)8'
```

---

## 自定义基线开发

### 创建新基线

**步骤**:

#### 1. 确定基线ID

根据适用系统选择合适的ID范围：
- CentOS: 1200-1299
- Debian: 1300-1399
- Ubuntu: 1400-1499
- 跨平台: 5000-5999

#### 2. 创建配置文件

创建文件 `config/linux/XXXX.yaml`：

```yaml
baseline_id: 1250
baseline_version: "1.0"
baseline_name: "我的自定义CentOS基线"
baseline_name_en: "My Custom CentOS Baseline"

system:
  - "centos7"
  - "centos8"

check_list: []
```

#### 3. 添加检查项

参考预定义基线，添加检查项：

```yaml
check_list:
  - check_id: 1
    type: "Identification"
    type_cn: "身份鉴别"
    title: "Custom check 1"
    title_cn: "自定义检查1"
    description: "..."
    description_cn: "..."
    solution: "..."
    solution_cn: "..."
    security: "high"
    check:
      rules:
        - type: "file_line_check"
          param: ["/path/to/file"]
          result: "expected_value"
```

#### 4. 验证配置

```bash
# 测试基线配置
./baseline <<EOF
{
  "baseline_id": 1250,
  "check_id_list": []
}
EOF
```

### 修改现有基线

**建议做法**:

1. 复制现有基线文件
2. 修改 baseline_id
3. 调整检查项
4. 保留原基线作为备份

**示例**:

```bash
# 复制 CentOS 基线
cp config/linux/1200.yaml config/linux/1250.yaml

# 编辑新基线
vim config/linux/1250.yaml
# 修改 baseline_id, baseline_name 等
# 添加/删除/修改检查项
```

### 添加检查项到现有基线

**步骤**:

1. 确定 check_id（使用未占用的ID）
2. 选择合适的分类（type）
3. 编写规则
4. 测试验证

**示例**:

```yaml
# 在 1200.yaml 末尾添加新检查项
- check_id: 200
  type: "Custom"
  type_cn: "自定义"
  title: "Check custom configuration"
  title_cn: "检查自定义配置"
  description: "..."
  description_cn: "..."
  solution: "..."
  solution_cn: "..."
  security: "mid"
  check:
    rules:
      - type: "command_check"
        param: ["custom_command"]
        result: "expected"
```

---

## 最佳实践

### 配置编写

**1. 使用有意义的 check_id**

```yaml
# Good: 按类别分配ID段
check_id: 1   # 密码策略 (1-20)
check_id: 21  # 账户安全 (21-40)
check_id: 41  # 文件权限 (41-60)

# Bad: 随机ID
check_id: 999
check_id: 1
check_id: 500
```

**2. 提供详细的描述和解决方案**

```yaml
# Good: 详细说明
description_cn: "密码有效期设置过长会增加密码泄漏风险。建议设置为90天，强制用户定期更换密码。"
solution_cn: "编辑 /etc/login.defs 文件，将 PASS_MAX_DAYS 参数设置为 90，然后对现有用户执行: chage --maxdays 90 <username>"

# Bad: 过于简单
description_cn: "密码有效期检查"
solution_cn: "修改配置"
```

**3. 合理使用 condition**

```yaml
# all: 所有条件必须满足（默认）
check:
  condition: "all"
  rules:
    - type: file_permission
      param: ["/etc/shadow", "600"]
      result: true
    - type: file_user_group
      param: ["/etc/shadow", "0:0"]
      result: true

# any: 任意条件满足即可
check:
  condition: "any"
  rules:
    - type: file_line_check
      param: ["/etc/ssh/sshd_config", "PubkeyAuthentication"]
      result: ".*yes$"
    - type: file_line_check
      param: ["/etc/ssh/sshd_config", "PasswordAuthentication"]
      result: "$(not).*yes$"
```

**4. 使用 filter 提取精确值**

```yaml
# Good: 使用 filter 提取数值
filter: 'PASS_MAX_DAYS\s+(\d+)'
result: '$(<=)90'

# Bad: 直接匹配整行（容易误判）
result: '.*PASS_MAX_DAYS.*90.*'
```

**5. 处理文件不存在情况**

```yaml
# file_line_check 会自动处理文件不存在
# 文件不存在时返回 false，不报错

# 如果文件可选，使用 any 条件
check:
  condition: "any"
  rules:
    - type: if_file_exist
      param: ["/etc/custom.conf"]
      result: false  # 文件不存在也通过

    - type: file_line_check
      param: ["/etc/custom.conf"]
      result: "secure_config"  # 文件存在且配置正确
```

### 安全等级设置

| 场景 | 安全等级 | 示例 |
|------|---------|------|
| 密码策略、文件权限、root访问 | high | /etc/shadow 权限 |
| 审计日志、资源限制 | mid | 日志保留策略 |
| 非关键配置、最佳实践 | low | 系统 banner |

### 性能优化

**1. 避免频繁执行耗时命令**

```yaml
# Bad: 多次执行同一命令
- type: command_check
  param: ["find / -type f -perm -002"]
  # 扫描整个文件系统，非常耗时

# Good: 只检查关键目录
- type: command_check
  param: ["find /etc /var /usr/bin -type f -perm -002"]
```

**2. 合并相关检查**

```yaml
# Good: 在一个检查项中验证多个相关条件
check:
  condition: "all"
  rules:
    - type: file_permission
      param: ["/etc/shadow", "600"]
      result: true
    - type: file_user_group
      param: ["/etc/shadow", "0:0"]
      result: true
```

**3. 使用 flag 参数减少匹配范围**

```yaml
# Good: 只匹配包含特定字符串的行
- type: file_line_check
  param: ["/etc/ssh/sshd_config", "PermitRootLogin"]  # flag
  result: "$(not).*yes$"

# Bad: 匹配所有行（性能差）
- type: file_line_check
  param: ["/etc/ssh/sshd_config"]
  result: ".*PermitRootLogin.*no.*"
```

### 测试验证

**1. 单项测试**

```bash
# 测试单个检查项
./baseline <<EOF
{
  "baseline_id": 1200,
  "check_id_list": [1]
}
EOF
```

**2. 分类测试**

```bash
# 测试特定类别的检查项（如 check_id 1-20）
./baseline <<EOF
{
  "baseline_id": 1200,
  "check_id_list": [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]
}
EOF
```

**3. 全量测试**

```bash
# 测试整个基线
./baseline <<EOF
{
  "baseline_id": 1200,
  "check_id_list": []
}
EOF
```

---

## 常见问题

### Q: 如何检查文件是否包含特定内容？

```yaml
- type: file_line_check
  param: ["/path/to/file"]
  result: ".*expected_content.*"
```

### Q: 如何检查文件不包含特定内容？

```yaml
- type: file_line_check
  param: ["/path/to/file"]
  result: "$(not).*unwanted_content.*"
```

### Q: 如何检查数值范围？

```yaml
# 检查值 >= 8 且 <= 90
check:
  condition: "all"
  rules:
    - type: file_line_check
      param: ["/etc/login.defs"]
      filter: 'PARAM\s+(\d+)'
      result: '$(>=)8'

    - type: file_line_check
      param: ["/etc/login.defs"]
      filter: 'PARAM\s+(\d+)'
      result: '$(<=)90'
```

### Q: 如何处理可选配置文件？

```yaml
check:
  condition: "any"
  rules:
    # 文件不存在也通过
    - type: if_file_exist
      param: ["/etc/optional.conf"]
      result: false

    # 文件存在且配置正确
    - type: file_line_check
      param: ["/etc/optional.conf"]
      result: "correct_config"
```

---

## 下一步阅读

- **理解调度机制** → [04-任务调度.md](./04-任务调度.md)
- **了解数据协议** → [05-数据协议.md](./05-数据协议.md)
- **深入规则引擎** → [02-规则引擎.md](./02-规则引擎.md)
