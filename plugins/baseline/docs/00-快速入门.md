# Elkeid Baseline 插件 - 快速入门

## 目录
- [项目概述](#项目概述)
- [功能特性](#功能特性)
- [支持平台](#支持平台)
- [快速开始](#快速开始)
- [基本使用](#基本使用)
- [文档导航](#文档导航)

---

## 项目概述

**Elkeid Baseline** 是 Elkeid 安全防护系统的核心组件之一，专门用于 Linux 系统的安全基线扫描和合规性检查。

### 什么是安全基线？

安全基线是一套预定义的安全配置规则，用于检查系统是否符合安全最佳实践。例如：
- 密码策略是否合规（长度、复杂度、有效期）
- 敏感文件权限是否正确（/etc/shadow, /etc/passwd）
- SSH配置是否安全（禁用root登录、禁用密码认证）
- 系统账户是否存在风险（重复用户名、弱密码）

### 核心功能

Baseline 插件通过以下方式实现安全检查：

1. **规则引擎** - 支持7种内置规则类型和复杂的条件匹配
2. **YAML配置** - 灵活的配置文件定义检查项
3. **自动调度** - 支持按需扫描和每日定时扫描
4. **结果上报** - 实时上报检查结果到 Elkeid Server

---

## 功能特性

### 核心特性

- **灵活的规则引擎**
  - 7种内置规则类型（命令检查、文件检查、权限验证等）
  - 支持复杂运算符（关系、逻辑、字符串匹配）
  - 支持正则表达式和过滤器

- **预定义基线**
  - CentOS 基线（1200）：~120个检查项
  - Debian 基线（1300）：~120个检查项
  - Ubuntu 基线（1400）：~120个检查项
  - 弱密码基线（5000）：~10个检查项

- **双重调度模式**
  - 按需扫描：服务器下发任务，立即执行
  - 定时扫描：每日自动执行（0:00-6:00随机时间）

- **可扩展架构**
  - 易于添加自定义基线
  - 支持自定义规则类型
  - 支持自定义检查函数

---

## 支持平台

### 操作系统支持

| 操作系统 | 版本 | 架构 |
|---------|------|------|
| CentOS | 6, 7, 8 | x86_64, ARM64 |
| Debian | 8, 9, 10 | x86_64, ARM64 |
| Ubuntu | 14.04, 16.04, 18.04, 20.04 | x86_64, ARM64 |

### 技术栈

- **开发语言**: Go 1.16+
- **配置格式**: YAML
- **依赖管理**: Go Modules

---

## 快速开始

### 环境要求

```bash
# 1. Go 环境
go version  # >= 1.16

# 2. 系统要求
# - Linux操作系统
# - root权限（需要读取敏感文件）
```

### 构建插件

#### x86_64 构建

```bash
cd /home/work/openSource/Elkeid/plugins/baseline
./build.sh
```

构建输出:
```
baseline-linux-amd64-1.0.1.19.tar.gz
baseline-linux-amd64-1.0.1.19.tar.gz.sha256sum.txt
```

#### ARM64 构建

```bash
cd /home/work/openSource/Elkeid/plugins/baseline
./build_arm.sh
```

构建输出:
```
baseline-linux-arm64-1.0.1.19.tar.gz
baseline-linux-arm64-1.0.1.19.tar.gz.sha256sum.txt
```

### 部署插件

1. **解压插件包**

```bash
tar -xzf baseline-linux-amd64-1.0.1.19.tar.gz
cd baseline
```

2. **目录结构**

```
baseline/
├── baseline          # 可执行文件
├── baseline.log      # 运行日志（运行后生成）
└── config/
    └── linux/
        ├── 1200.yaml  # CentOS基线
        ├── 1300.yaml  # Debian基线
        ├── 1400.yaml  # Ubuntu基线
        └── 5000.yaml  # 弱密码基线
```

3. **运行插件**

```bash
# 需要root权限
sudo ./baseline
```

### 验证安装

查看日志确认插件正常运行：

```bash
tail -f baseline.log
```

预期输出：
```
[baseline] Plugin client initialized
[baseline] Task receiver started
[baseline] Daily cronjob scheduled
```

---

## 基本使用

### 使用场景1: 按需扫描

通过 Elkeid Server 下发任务，指定基线ID和检查项列表：

**任务格式**:
```json
{
    "baseline_id": 1200,
    "check_id_list": [1, 2, 3, 10, 20]
}
```

**说明**:
- `baseline_id`: 基线ID（1200=CentOS, 1300=Debian, 1400=Ubuntu）
- `check_id_list`: 要执行的检查项ID列表（空数组=全部检查）

### 使用场景2: 定时扫描

插件每日自动执行基线扫描：
- **执行时间**: 每天 0:00-6:00 之间随机时间
- **扫描基线**: 根据系统类型自动选择
  - CentOS系统 → 扫描 1200 基线
  - Debian系统 → 扫描 1300 基线
  - Ubuntu系统 → 扫描 1400 基线

### 查看扫描结果

扫描结果会上报到 Elkeid Server，包含：

**结果数据结构**:
```json
{
    "baseline_id": 1200,
    "baseline_version": "1.0",
    "check_list": [
        {
            "check_id": 1,
            "result": 2,
            "security": "high",
            "title": "Ensure password expiration is 180 days or less",
            "type": "Identification",
            "solution": "Set PASS_MAX_DAYS parameter to 90 in /etc/login.defs"
        }
    ]
}
```

**结果码说明**:
- `1` - 检查通过
- `2` - 检查失败（需要修复）
- `-1` - 检查出错
- `-2` - 配置错误
- `-3` - 文件读取错误

---

## 文档导航

本项目的完整文档按模块组织，建议按以下顺序阅读：

### 1. [系统架构设计](./01-架构设计.md)
**适合人群**: 想要了解插件整体设计的开发者

**内容包括**:
- 插件整体架构图
- 核心模块职责与交互
- 数据流向分析
- 与Elkeid Agent的集成方式

### 2. [规则引擎设计](./02-规则引擎.md)
**适合人群**: 需要扩展规则或深入理解检查逻辑的开发者

**内容包括**:
- 规则引擎核心机制
- 7种内置规则类型详解
- 运算符实现（关系、逻辑、字符串）
- 条件逻辑（all/any/none）
- 过滤器（filter）机制
- 如何扩展新规则

### 3. [基线配置设计](./03-基线配置.md)
**适合人群**: 需要自定义基线或添加检查项的安全工程师

**内容包括**:
- YAML配置文件结构详解
- 预定义基线说明
- 检查项分类与安全等级
- 配置示例与最佳实践
- 自定义基线开发指南

### 4. [任务调度设计](./04-任务调度.md)
**适合人群**: 需要理解插件运行机制的运维人员

**内容包括**:
- 任务调度机制
- 按需扫描与定时扫描
- 调度算法（随机延迟策略）
- 并发控制（goroutine管理）
- 资源限制策略

### 5. [数据协议设计](./05-数据协议.md)
**适合人群**: 需要对接Elkeid Server的开发者

**内容包括**:
- 任务接收协议
- 结果上报格式（DataType: 8000, 8010）
- 返回码定义
- 错误处理机制
- 日志规范

---

## 常见问题

### Q: 为什么需要root权限？

A: Baseline 插件需要读取敏感文件（如 `/etc/shadow`, `/etc/passwd`）来检查密码策略和用户配置，这些文件只有root用户才有权限访问。

### Q: 如何添加自定义检查项？

A: 编辑对应基线的YAML配置文件，在 `check_list` 中添加新的检查项定义。详见 [基线配置设计](./03-基线配置.md)。

### Q: 可以只扫描特定检查项吗？

A: 可以。在任务数据中指定 `check_id_list` 参数，只包含需要扫描的检查项ID。

### Q: 定时扫描的时间可以修改吗？

A: 定时扫描时间硬编码在 `main.go` 中（0:00-6:00随机），如需修改需要重新编译插件。

### Q: 如何禁用定时扫描？

A: 当前版本不支持配置禁用。如需禁用，需要修改源码注释掉 `main.go` 中的 cronjob 相关代码并重新编译。

---

## 快速示例

### 示例1: 检查密码有效期策略

**配置** (在 1200.yaml 中):
```yaml
check_list:
  - check_id: 1
    type: "Identification"
    title_cn: "设置密码失效时间<=90天"
    security: "high"
    check:
      rules:
        - type: "file_line_check"
          param:
            - "/etc/login.defs"
          filter: '\s*\t*PASS_MAX_DAYS\s*\t*(\d+)'
          result: '$(<=)90'
```

**说明**:
- 检查 `/etc/login.defs` 文件
- 使用正则过滤器提取 `PASS_MAX_DAYS` 参数值
- 验证该值是否 <= 90 天

### 示例2: 检查文件权限

**配置**:
```yaml
- type: "file_permission"
  param:
    - "/etc/shadow"
    - "600"
  result: true
```

**说明**:
- 检查 `/etc/shadow` 文件权限
- 验证权限是否小于 600（即 000, 400, 600 均通过）

### 示例3: 检查SSH配置

**配置**:
```yaml
- type: "file_line_check"
  param:
    - "/etc/ssh/sshd_config"
    - "PermitRootLogin"
  result: "$(not).*yes$"
```

**说明**:
- 检查 `/etc/ssh/sshd_config` 文件
- 查找包含 `PermitRootLogin` 的行
- 验证该行不包含 `yes`（使用 `$(not)` 逻辑非运算符）

---

## 性能指标

- **单次扫描时间**: 30-60秒（120个检查项）
- **内存占用**: ~50MB
- **CPU使用**: 最多4核心
- **日志大小**: 取决于扫描频率，建议定期清理

---

## 下一步

选择您感兴趣的主题深入学习：

1. **了解架构** → 阅读 [01-架构设计.md](./01-架构设计.md)
2. **扩展规则** → 阅读 [02-规则引擎.md](./02-规则引擎.md)
3. **自定义基线** → 阅读 [03-基线配置.md](./03-基线配置.md)
4. **调优性能** → 阅读 [04-任务调度.md](./04-任务调度.md)
5. **集成开发** → 阅读 [05-数据协议.md](./05-数据协议.md)

---

## 获取帮助

- **项目地址**: https://github.com/bytedance/Elkeid
- **问题反馈**: 提交 GitHub Issue
- **文档贡献**: 欢迎提交 Pull Request

---

**祝您使用愉快！**
