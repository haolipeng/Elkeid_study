# Elkeid Baseline 插件 - 系统架构设计

## 目录
- [整体架构](#整体架构)
- [核心模块](#核心模块)
- [数据流向](#数据流向)
- [模块交互](#模块交互)
- [技术选型](#技术选型)

---

## 整体架构

### 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                      Elkeid Agent / Server                       │
│                    (任务下发 & 结果接收)                          │
└──────────────┬────────────────────────────┬─────────────────────┘
               │                            │
       Task Submission              Result/Status Report
      (JSON via Plugin SDK)         (DataType: 8000, 8010)
               │                            │
               ▼                            ▲
┌──────────────────────────────────────────────────────────────────┐
│                     Baseline Plugin Process                       │
│                                                                   │
│  ┌────────────────────────────────────────────────────────┐     │
│  │          Main Controller (main.go)                     │     │
│  │  ┌──────────────┐              ┌──────────────────┐   │     │
│  │  │ Task Receiver│              │  Daily Cronjob   │   │     │
│  │  │  (Goroutine) │              │   Scheduler      │   │     │
│  │  └──────┬───────┘              └────────┬─────────┘   │     │
│  └─────────┼────────────────────────────────┼─────────────┘     │
│            │                                │                   │
│            └────────────┬───────────────────┘                   │
│                         │                                       │
│                         ▼                                       │
│  ┌────────────────────────────────────────────────────────┐    │
│  │      Analysis Orchestrator (analysis.go)               │    │
│  │  ┌──────────────────────────────────────────────┐     │    │
│  │  │  1. Parse task data (baseline_id, check_ids) │     │    │
│  │  │  2. Load YAML config                          │     │    │
│  │  │  3. Iterate check items                       │     │    │
│  │  │  4. Format results                            │     │    │
│  │  └──────────────────────────────────────────────┘     │    │
│  └────────────────────────┬───────────────────────────────┘    │
│                            │                                    │
│                ┌───────────┴──────────┐                        │
│                ▼                      ▼                        │
│  ┌─────────────────────┐    ┌─────────────────────┐           │
│  │  YAML Config Loader │    │   Rule Engine       │           │
│  │   (infra/yaml.go)   │───▶│ (rule_engine.go)    │           │
│  └─────────────────────┘    └──────────┬──────────┘           │
│                                         │                      │
│                                         ▼                      │
│                            ┌─────────────────────┐             │
│                            │  Rule Executor      │             │
│                            │   (rules.go)        │             │
│                            └──────────┬──────────┘             │
│                                       │                        │
│      ┌────────────────────────────────┼────────────┐          │
│      │                                │            │          │
│      ▼                                ▼            ▼          │
│  ┌────────────┐              ┌──────────────┐ ┌──────────┐   │
│  │  Command   │              │ File Checks  │ │  Custom  │   │
│  │   Check    │              │ - Line Check │ │   Funcs  │   │
│  │ (exec.Cmd) │              │ - Permission │ │          │   │
│  └────────────┘              │ - User/Group │ └──────────┘   │
│                               │ - MD5 Check  │                │
│                               └──────────────┘                │
│                                                                │
│  ┌────────────────────────────────────────────────────────┐   │
│  │       Infrastructure Layer (infra/)                    │   │
│  │  ┌──────────────┐              ┌──────────────┐       │   │
│  │  │    Logger    │              │ YAML Parser  │       │   │
│  │  │  (log.go)    │              │  (yaml.go)   │       │   │
│  │  └──────────────┘              └──────────────┘       │   │
│  └────────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────┘
```

### 架构特点

1. **模块化设计**: 清晰的职责分离，易于维护和扩展
2. **并发处理**: 使用 Goroutine 实现任务接收和定时调度并行
3. **插件式集成**: 通过 Plugin SDK 与 Elkeid Agent 解耦
4. **配置驱动**: YAML 配置文件定义检查规则，无需修改代码

---

## 核心模块

### 1. 主控模块 (main.go)

**职责**:
- 插件生命周期管理
- 任务接收与分发
- 定时调度控制
- 结果数据上报

**核心代码**:

```go
// main.go:75-154
func main() {
    // 任务接收器 (独立 Goroutine)
    go func() {
        for {
            // 从 Elkeid Agent 接收任务
            pluginsTask, err := pluginClient.ReceiveTask()
            if err != nil {
                infra.Loger.Println("getTask error:", err.Error())
                break
            }

            // 异步处理任务 (每个任务一个 Goroutine)
            go func() {
                // 执行基线分析
                retBaselineInfo, analysisErr := check.Analysis(pluginsTask.Data)

                // 上报结果 (DataType: 8000)
                err = SendServer(retBaselineInfo, pluginsTask.Token)

                // 上报状态 (DataType: 8010)
                if analysisErr != nil {
                    TaskStatusSendServer(TaskStatusFailed, pluginsTask.Token, analysisErr.Error())
                } else {
                    TaskStatusSendServer(TaskStatusSuccess, pluginsTask.Token, "")
                }
            }()
        }
    }()

    // 定时调度器
    dailyTicker := time.NewTicker(...)
    for {
        select {
        case <-dailyTicker.C:
            // 根据系统类型选择默认基线
            baselineIdList := getDefaultBaseline(linux.GetSystemType())

            // 执行扫描
            for _, baselineId := range baselineIdList {
                retBaselineInfo, _ := check.Analysis(baselineId)
                SendServer(retBaselineInfo, "")
            }
        }
    }
}
```

**关键配置**:
```go
// main.go:25-26
func init() {
    runtime.GOMAXPROCS(4)  // 限制最多使用4个CPU核心
    pluginClient = plugins.New()  // 初始化插件客户端
}
```

### 2. 分析编排模块 (analysis.go)

**职责**:
- 任务参数解析
- 基线配置加载
- 检查流程编排
- 结果格式化

**核心流程**:

```go
// analysis.go:127-151
func Analysis(data interface{}) (retBaselineInfo RetBaselineInfo, err error) {
    var taskData TaskData

    // 1. 解析任务参数
    switch data.(type) {
    case int:
        taskData.BaselineId = data.(int)  // 定时任务传入 int
    case string:
        json.Unmarshal([]byte(data.(string)), &taskData)  // 按需任务传入 JSON
    }

    // 2. 执行分析
    retBaselineInfo, err = AnalysisBaseline(taskData)

    // 3. 设置状态
    if err != nil {
        retBaselineInfo.Status = BaselineStatusError
        retBaselineInfo.Msg = err.Error()
    } else {
        retBaselineInfo.Status = BaselineStatusSuccess
    }

    return retBaselineInfo, err
}
```

**基线加载逻辑**:

```go
// analysis.go:45-59
func getBaselineConfigData(baselineId int) (baselineInfo BaselineInfo, err error) {
    var yamlPath string

    // 根据 baseline_id 确定配置文件路径
    if baselineId < 6000 {
        yamlPath = fmt.Sprintf("config/linux/%d.yaml", baselineId)
    } else {
        yamlPath = fmt.Sprintf("config/container/%d.yaml", baselineId)
    }

    // 加载 YAML 配置
    err = infra.BindYaml(yamlPath, &baselineInfo)
    return
}
```

**检查项迭代**:

```go
// analysis.go:82-121
for _, checkInfo := range baselineInfo.CheckList {
    // 过滤检查项（如果指定了 check_id_list）
    if len(checkIdList) != 0 {
        if _, ok := taskCheckIdMap[checkInfo.CheckId]; !ok {
            continue
        }
    }

    // 复制检查项元数据
    var retcheckInfo RetCheckInfo
    retcheckInfo.CheckId = checkInfo.CheckId
    retcheckInfo.Security = checkInfo.Security
    // ... 复制其他字段

    // 执行规则检查
    ifPass, err := AnalysisRule(checkInfo.Check)

    // 处理结果
    if err != nil {
        retcheckInfo.Result = ErrorCode
        // 解析错误码
    } else {
        if ifPass {
            retcheckInfo.Result = SuccessCode  // 1
        } else {
            retcheckInfo.Result = FailCode     // 2
        }
    }

    retBaselineInfo.CheckList = append(retBaselineInfo.CheckList, retcheckInfo)
}
```

### 3. 规则引擎 (rule_engine.go)

**职责**:
- 规则条件评估
- 运算符解析
- 结果匹配
- 类型转换

**核心入口**:

```go
// rule_engine.go:307-337
func AnalysisRule(check BaselineCheck) (ifPass bool, err error) {
    condition := check.Condition
    if condition == "" {
        condition = "all"  // 默认条件
    }

    for _, rule := range check.Rules {
        ifCheck, err := CheckRule(rule)
        if err != nil {
            return false, err
        }

        // 根据条件类型判断
        if ifCheck {
            if condition == "any" {
                return true, err  // 任意一个通过即返回
            } else if condition == "none" {
                return false, err  // none条件下，通过反而失败
            }
        } else {
            if condition == "all" {
                return false, err  // all条件下，一个失败即返回
            }
        }
    }

    // 所有规则遍历完毕
    if condition == "any" {
        return false, err  // any条件下全失败
    } else {
        return true, err   // all/none条件下全通过
    }
}
```

**规则分发**:

```go
// rule_engine.go:249-304
func CheckRule(ruleStruct RuleStruct) (ifPass bool, err error) {
    var funcRes interface{}

    // 根据规则类型调用不同的检查函数
    switch ruleStruct.Type {
    case "command_check":
        funcRes, err = CommandCheck(ruleStruct.Param)
    case "if_file_exist":
        funcRes, err = IfFileExist(ruleStruct.Param)
    case "file_permission":
        funcRes, err = FilePermission(ruleStruct.Param)
    case "file_user_group":
        funcRes, err = FileUserGroup(ruleStruct.Param)
    case "file_line_check":
        funcRes, err = FileLineCheck(ruleStruct, ResultMatch)
    case "func_check":
        funcRes, err = FuncCheck(ruleStruct.Param)
    case "file_md5_check":
        funcRes, err = FileMd5Check(ruleStruct.Param)
    default:
        return false, errors.New("unknown rule type")
    }

    if err != nil {
        return false, err
    }

    // 特殊处理 file_line_check（已在函数内匹配）
    if ruleStruct.Type == "file_line_check" {
        ifPass = funcRes.(bool)
    } else {
        ifPass, err = ResultMatch(ruleStruct, funcRes)
    }

    return ifPass, err
}
```

详细的规则引擎机制请参考 [02-规则引擎.md](./02-规则引擎.md)。

### 4. 规则执行器 (rules.go)

**职责**: 实现具体的检查规则

**规则类型**:

| 规则类型 | 函数名 | 功能 | 返回类型 |
|---------|--------|------|---------|
| command_check | CommandCheck | 执行Shell命令 | string |
| if_file_exist | IfFileExist | 文件存在性检查 | bool |
| file_permission | FilePermission | 文件权限校验 | bool |
| file_user_group | FileUserGroup | 文件所有者验证 | bool |
| file_line_check | FileLineCheck | 逐行文件内容匹配 | bool |
| file_md5_check | FileMd5Check | 文件MD5校验 | bool |
| func_check | FuncCheck | 自定义函数检查 | bool |

**示例实现 - 命令检查**:

```go
// rules.go:24-49
func CommandCheck(param []string) (result interface{}, err error) {
    command := param[0]
    argArray := strings.Split(command, " ")

    // 执行命令
    cmd := exec.Command(argArray[0], argArray[1:]...)
    buf, err := cmd.Output()

    if err != nil {
        // 特殊参数: ignore_exit 忽略命令错误
        if len(param) == 2 && param[1] == "ignore_exit" {
            return true, nil
        }
        return false, nil
    }

    return string(buf), err  // 返回命令输出
}
```

**示例实现 - 文件权限**:

```go
// rules.go:136-159
func FilePermission(param []string) (result bool, err error) {
    filePath := param[0]
    fileNeedMode, _ := strconv.Atoi(param[1])

    // 获取文件信息
    fileInfo, err := os.Stat(filePath)
    if err != nil {
        if strings.Contains(err.Error(), "no such file") {
            return true, nil  // 文件不存在，视为通过
        }
        return
    }

    // 获取实际权限
    fileRealMode, _ := strconv.Atoi(strconv.FormatInt(int64(fileInfo.Mode()), 8))

    // 验证权限（实际权限应小于需求权限）
    return fileRealMode < fileNeedMode, err
}
```

### 5. 操作系统检测模块 (os_system.go)

**职责**: 识别 Linux 发行版类型

**实现**:

```go
func GetSystemType() string {
    // 读取 /etc/issue 文件
    file, err := os.Open("/etc/issue")
    if err != nil {
        return "centos"  // 默认返回 centos
    }
    defer file.Close()

    scanner := bufio.NewScanner(file)
    if scanner.Scan() {
        line := strings.ToLower(scanner.Text())

        // 根据关键字判断
        if strings.Contains(line, "ubuntu") {
            return "ubuntu"
        } else if strings.Contains(line, "debian") {
            return "debian"
        }
    }

    return "centos"
}
```

### 6. 基础设施模块 (infra/)

#### 日志模块 (log.go)

```go
var Loger *log.Logger

func init() {
    logFile, _ := os.OpenFile("baseline.log",
        os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0666)

    Loger = log.New(logFile, "[baseline] ",
        log.Ldate|log.Ltime|log.Lshortfile)
}
```

**日志格式**:
```
[baseline] 2024/01/15 10:30:45 main.go:93: sendServer success: 1200
```

#### YAML解析模块 (yaml.go)

```go
import (
    "github.com/spf13/viper"
    "gopkg.in/yaml.v2"
)

func BindYaml(yamlPath string, config interface{}) error {
    viper.SetConfigFile(yamlPath)

    if err := viper.ReadInConfig(); err != nil {
        return err
    }

    return viper.Unmarshal(config)
}
```

---

## 数据流向

### 按需扫描流程

```
1. Elkeid Server 下发任务
   └─> Plugin SDK (ReceiveTask)
       └─> main.go (Task Receiver Goroutine)
           └─> check.Analysis(taskData)
               ├─> analysis.go (解析任务参数)
               ├─> infra.BindYaml (加载配置)
               ├─> AnalysisRule (执行规则)
               │   └─> CheckRule (规则分发)
               │       └─> CommandCheck / FileCheck / ... (具体检查)
               └─> 格式化结果
                   └─> SendServer (上报结果)
                       └─> Plugin SDK (SendRecord)
                           └─> Elkeid Server
```

### 定时扫描流程

```
1. Daily Ticker 触发
   └─> linux.GetSystemType() (检测操作系统)
       └─> 选择默认基线
           └─> check.Analysis(baselineId)
               └─> [同上述按需扫描流程]
                   └─> SendServer (上报结果)
                       └─> Elkeid Server
```

### 数据传输格式

#### 输入数据 (Task Data)

```json
{
    "baseline_id": 1200,
    "check_id_list": [1, 2, 3]
}
```

#### 输出数据 (Result)

```json
{
    "baseline_id": 1200,
    "baseline_version": "1.0",
    "status": "success",
    "msg": "",
    "check_list": [
        {
            "check_id": 1,
            "result": 2,
            "security": "high",
            "type": "Identification",
            "title": "Ensure password expiration...",
            "description": "The PASS_MAX_DAYS parameter...",
            "solution": "Set the PASS_MAX_DAYS parameter..."
        }
    ]
}
```

---

## 模块交互

### 交互时序图

```
┌──────┐        ┌──────┐        ┌──────────┐      ┌─────────┐      ┌──────┐
│Server│        │Main  │        │Analysis  │      │  Rule   │      │Rules │
└──┬───┘        └──┬───┘        └────┬─────┘      └────┬────┘      └──┬───┘
   │                │                 │                 │              │
   │ SendTask       │                 │                 │              │
   │───────────────▶│                 │                 │              │
   │                │                 │                 │              │
   │                │ Analysis(data)  │                 │              │
   │                │────────────────▶│                 │              │
   │                │                 │                 │              │
   │                │                 │ LoadYAML        │              │
   │                │                 │─────────┐       │              │
   │                │                 │         │       │              │
   │                │                 │◀────────┘       │              │
   │                │                 │                 │              │
   │                │                 │ AnalysisRule    │              │
   │                │                 │────────────────▶│              │
   │                │                 │                 │              │
   │                │                 │                 │ CheckRule    │
   │                │                 │                 │─────────────▶│
   │                │                 │                 │              │
   │                │                 │                 │ CommandCheck │
   │                │                 │                 │──────────┐   │
   │                │                 │                 │          │   │
   │                │                 │                 │◀─────────┘   │
   │                │                 │                 │              │
   │                │                 │                 │ ResultMatch  │
   │                │                 │                 │◀─────────────│
   │                │                 │                 │              │
   │                │                 │ Result          │              │
   │                │                 │◀────────────────│              │
   │                │                 │                 │              │
   │                │ RetBaselineInfo │                 │              │
   │                │◀────────────────│                 │              │
   │                │                 │                 │              │
   │ SendRecord     │                 │                 │              │
   │◀───────────────│                 │                 │              │
   │                │                 │                 │              │
```

### 关键接口

#### Plugin SDK 接口

```go
// 任务接收
type Task struct {
    Token string      // 任务令牌
    Data  interface{} // 任务数据（JSON字符串）
}
func (c *Client) ReceiveTask() (*Task, error)

// 结果上报
type Record struct {
    DataType  int32     // 数据类型（8000=结果, 8010=状态）
    Timestamp int64     // 时间戳
    Data      *Payload  // 负载数据
}
func (c *Client) SendRecord(record *Record) error
```

#### 内部接口

```go
// 分析接口
func Analysis(data interface{}) (RetBaselineInfo, error)

// 规则引擎接口
func AnalysisRule(check BaselineCheck) (bool, error)
func CheckRule(ruleStruct RuleStruct) (bool, error)

// 规则执行接口
func CommandCheck(param []string) (interface{}, error)
func FileLineCheck(ruleStruct RuleStruct, resultMatch ResultMatchFunc) (bool, error)
// ... 其他规则函数
```

---

## 技术选型

### 编程语言

**Go 1.16+**

选择理由:
- 原生支持并发（Goroutine）
- 优秀的标准库（exec, os, regexp）
- 静态编译，部署简单
- 性能优异，内存占用低

### 依赖库

| 库名 | 版本 | 用途 |
|------|------|------|
| github.com/bytedance/plugins | local | Elkeid Plugin SDK |
| github.com/spf13/viper | v1.4.0 | 配置管理 |
| gopkg.in/yaml.v2 | v2.4.0 | YAML解析 |

### 配置格式

**YAML**

选择理由:
- 可读性强，易于编写和维护
- 支持复杂的嵌套结构
- 注释支持，便于文档化
- 工具链成熟（viper, yaml.v2）

### 并发模型

**Goroutine + Channel**

```go
// 任务接收器
go func() {
    for {
        task, _ := pluginClient.ReceiveTask()

        // 每个任务独立处理
        go func() {
            result, _ := check.Analysis(task.Data)
            SendServer(result, task.Token)
        }()
    }
}()

// 定时调度器
go func() {
    ticker := time.NewTicker(24 * time.Hour)
    for range ticker.C {
        // 执行定时扫描
    }
}()
```

---

## 设计原则

### 1. 单一职责原则

每个模块只负责一个明确的功能：
- main.go → 任务调度
- analysis.go → 流程编排
- rule_engine.go → 规则评估
- rules.go → 规则实现

### 2. 开闭原则

**对扩展开放，对修改封闭**:
- 新增规则类型：只需在 rules.go 添加新函数
- 新增基线：只需添加新的 YAML 配置文件
- 新增运算符：只需在 rule_engine.go 添加新分支

### 3. 依赖倒置原则

**面向接口编程**:
```go
// ResultMatchFunc 函数签名接口
type ResultMatchFunc func(RuleStruct, interface{}) (bool, error)

// FileLineCheck 依赖抽象的匹配函数
func FileLineCheck(ruleStruct RuleStruct, resultMatch ResultMatchFunc) (bool, error)
```

### 4. 配置驱动

**业务逻辑与配置分离**:
- 检查规则定义在 YAML 文件中
- 代码只负责规则引擎实现
- 无需修改代码即可调整检查项

---

## 性能考虑

### 资源限制

```go
runtime.GOMAXPROCS(4)  // 限制CPU核心数
```

**原因**:
- 避免占用过多系统资源
- 防止影响其他进程运行
- 基线扫描非实时性任务，无需高并发

### 并发控制

- **任务接收**: 独立 Goroutine，不阻塞主流程
- **任务处理**: 每个任务一个 Goroutine，隔离执行
- **定时调度**: 独立 Goroutine，与按需扫描并行

### 错误处理

- 文件不存在不报错（很多检查项的文件可能不存在）
- 命令执行失败返回 false（而非 error）
- 配置错误返回特定错误码（-2）

---

## 扩展性设计

### 新增规则类型

1. 在 `rules.go` 中实现新函数
2. 在 `rule_engine.go` 的 `CheckRule` 中添加 case 分支
3. 在 YAML 配置中使用新类型

### 新增基线

1. 创建新的 YAML 文件（如 `6100.yaml`）
2. 定义 baseline_id 和 check_list
3. 通过任务下发指定新 baseline_id

### 新增运算符

1. 在 `rule_engine.go` 的 `DealMathCompute` 或 `ResultMatch` 中添加逻辑
2. 在 YAML 配置中使用新运算符

---

## 下一步阅读

- **深入规则引擎** → [02-规则引擎.md](./02-规则引擎.md)
- **学习配置编写** → [03-基线配置.md](./03-基线配置.md)
- **理解调度机制** → [04-任务调度.md](./04-任务调度.md)
- **了解数据协议** → [05-数据协议.md](./05-数据协议.md)
