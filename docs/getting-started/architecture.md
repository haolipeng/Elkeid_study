# Elkeid Driver 架构文档 (Elkeid Driver Architecture)

## 文档概述 (Document Overview)

本文档详细描述 Elkeid Driver 的系统架构、组件交互、数据流和设计原理。

This document describes the system architecture, component interactions, data flow, and design principles of Elkeid Driver in detail.

---

## 1. 系统架构概览 (System Architecture Overview)

### 1.1 整体架构图 (Overall Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Elkeid Driver System                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Kernel Space (内核空间)                        │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐│   │
│  │  │                   hids_driver.ko (内核模块)                      ││   │
│  │  │  ┌─────────────────────────────────────────────────────────┐    ││   │
│  │  │  │              Kprobe Hook Subsystem                       │    ││   │
│  │  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │    ││   │
│  │  │  │  │ Kprobe      │  │ Kretprobe   │  │ Tracepoint      │  │    ││   │
│  │  │  │  │ Handlers    │  │ Handlers    │  │ Handlers        │  │    ││   │
│  │  │  │  └─────────────┘  └─────────────┘  └─────────────────┘  │    ││   │
│  │  │  │                         │                                 │    ││   │
│  │  │  │                         ▼                                 │    ││   │
│  │  │  │  ┌─────────────────────────────────────────────────────┐  │    ││   │
│  │  │  │  │         smith_hook.c (5,101 行)                      │  │    ││   │
│  │  │  │  │   • 40+ Hook Types                                  │  │    ││   │
│  │  │  │  │   • 2555+ Tracepoint Probes                         │  │    ││   │
│  │  │  │  │   • Data Collection & Formatting                    │  │    ││   │
│  │  │  │  └─────────────────────────────────────────────────────┘  │    ││   │
│  │  │  └─────────────────────────────────────────────────────────┘    ││   │
│  │  │                         │                                       ││   │
│  │  │                         ▼                                       ││   │
│  │  │  ┌─────────────────────────────────────────────────────────┐    ││   │
│  │  │  │              Filter Subsystem (filter.c)                 │    ││   │
│  │  │  │  ┌────────────────────────────────────────────────────┐ │    ││   │
│  │  │  │  │  Allowlist Filtering (Red-Black Tree)              │ │    ││   │
│  │  │  │  │  • Executable Path Allowlist                       │ │    ││   │
│  │  │  │  │  • Argument Allowlist                              │ │    ││   │
│  │  │  │  └────────────────────────────────────────────────────┘ │    ││   │
│  │  │  └─────────────────────────────────────────────────────────┘    ││   │
│  │  │                         │                                       ││   │
│  │  │                         ▼                                       ││   │
│  │  │  ┌─────────────────────────────────────────────────────────┐    ││   │
│  │  │  │         Per-CPU Ring Buffer (trace_buffer.c)             │    ││   │
│  │  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    ││   │
│  │  │  │  │ CPU 0   │ │ CPU 1   │ │ CPU 2   │ │ CPU N   │       │    ││   │
│  │  │  │  │ Buffer  │ │ Buffer  │ │ Buffer  │ │ Buffer  │       │    ││   │
│  │  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    ││   │
│  │  │  └─────────────────────────────────────────────────────────┘    ││   │
│  │  │                         │                                       ││   │
│  │  │                         ▼                                       ││   │
│  │  │  ┌─────────────────────────────────────────────────────────┐    ││   │
│  │  │  │           Trace Subsystem (trace.c)                      │    ││   │
│  │  │  │  ┌────────────────────────────────────────────────────┐ │    ││   │
│  │  │  │  │  /proc/elkeid-endpoint (只读输出)                   │ │    ││   │
│  │  │  │  └────────────────────────────────────────────────────┘ │    ││   │
│  │  │  └─────────────────────────────────────────────────────────┘    ││   │
│  │  │                                                                  ││   │
│  │  │  ┌─────────────────────────────────────────────────────────┐    ││   │
│  │  │  │     Anti-Rootkit Subsystem (anti_rootkit.c)              │    ││   │
│  │  │  │  • Hidden Module Detection                               │    ││   │
│  │  │  │  • Syscall Table Hook Detection                          │    ││   │
│  │  │  │  • IDT Hook Detection                                     │    ││   │
│  │  │  │  • Proc Filesystem Hook Detection                        │    ││   │
│  │  │  └─────────────────────────────────────────────────────────┘    ││   │
│  │  └─────────────────────────────────────────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        User Space (用户空间)                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐│   │
│  │  │                 Elkeid Agent (插件系统)                          ││   │
│  │  │  ┌──────────────┐         ┌─────────────────────────────────┐  ││   │
│  │  │  │ Driver Plugin │────────▶│ Data Parsing & Analysis        │  ││   │
│  │  │  └──────────────┘         └─────────────────────────────────┘  ││   │
│  │  │                                                                  ││   │
│  │  │  ┌────────────────────────────────────────────────────────────┐ ││   │
│  │  │  │  /dev/hids_driver_allowlist (白名单配置接口)                │ ││   │
│  │  │  └────────────────────────────────────────────────────────────┘ ││   │
│  │  └─────────────────────────────────────────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 三大子系统 (Three Major Subsystems)

```
┌─────────────────────────────────────────────────────────────────┐
│                     Driver Module (init.c)                      │
│                  模块版本: 1.7.0.24                               │
│                  许可证: GPL v2                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┼─────────────┐
                │             │             │
                ▼             ▼             ▼
    ┌──────────────────┐ ┌──────────────┐ ┌─────────────────┐
    │     trace        │ │ anti_rootkit │ │  kprobe_hook    │
    │  (trace.c)       │ │(anti_rootkit │ │ (smith_hook.c)  │
    │                  │ │     .c)      │ │                 │
    │ • 环形缓冲区管理  │ │ • 隐藏模块   │ │ • Kprobe 注册   │
    │ • 用户空间通信    │ │   检测       │ │ • Kretprobe 注册│
    │ • 事件格式化      │ │ • Syscall    │ │ • Tracepoint    │
    │                  │ │   Hook 检测  │ │   注册          │
    │ • /proc/         │ │ • IDT Hook   │ │ • 数据采集      │
    │   elkeid-endpoint│ │   检测       │ │                 │
    └──────────────────┘ └──────────────┘ └─────────────────┘
```

---

## 2. 模块初始化流程 (Module Initialization Flow)

### 2.1 初始化序列图 (Initialization Sequence)

```
                   用户空间               内核空间
                   ───────               ───────

                        │                   │
                        │  insmod hids_driver.ko
                        │ ──────────────────▶│
                        │                   │
                        │                   │  ┌────────────────────┐
                        │                   │  │ kernel loads module│
                        │                   │  └────────────────────┘
                        │                   │           │
                        │                   │           ▼
                        │                   │  ┌────────────────────┐
                        │                   │  │  module_init()     │
                        │                   │  │  ────────          │
                        │                   │  │ kprobes_init()     │
                        │                   │  └────────────────────┘
                        │                   │           │
                        │                   │    ┌──────┴──────┐
                        │                   │    ▼             ▼
                        │                   │  ┌─────────┐ ┌──────────────┐
                        │                   │  │ trace_  │ │ anti_rootkit │
                        │                   │  │ init()  │ │   _init()    │
                        │                   │  └────┬────┘ └──────┬───────┘
                        │                   │       │             │
                        │                   │       └──────┬──────┘
                        │                   │              ▼
                        │                   │         ┌──────────────┐
                        │                   │         │ smith_hook   │
                        │                   │         │   _init()    │
                        │                   │         └──────┬───────┘
                        │                   │                │
                        │                   │    ┌───────────┴───────────┐
                        │                   │    │   All 3 subsystems   │
                        │                   │    │   initialized        │
                        │                   │    │   successfully        │
                        │                   │    └──────────────────────┘
                        │                   │                │
                        │ ◀─────────────────│                │
                        │  返回 0 (成功)     │                │
                        │                   │                ▼
                        │                   │  ┌────────────────────┐
                        │                   │  │ Module active,      │
                        │                   │  │ ready to collect    │
                        │                   │  │ security events     │
                        │                   │  └────────────────────┘
```

### 2.2 初始化代码详解 (init.c:22-45)

```c
static int __init kprobes_init(void)
{
    int i, rc = 0;

    // 按顺序初始化三个子系统
    for (i = 0; i < ARRAY_SIZE(__mod_entry); i++) {
        const struct kprobe_initcall *kic = __mod_entry[i];
        if (kic && kic->init) {
            rc = kic->init();           // 调用子系统的 init 函数
            if (rc < 0)
                goto exit;              // 失败时执行清理
        }
    }

    return 0;

// 错误处理：按相反顺序清理已初始化的子系统
exit:
    while (i-- > 0) {
        const struct kprobe_initcall *kic = __mod_entry[i];
        if (kic && kic->exit)
            kic->exit();                // 调用子系统的 exit 函数
    }

    return rc;
}
```

### 2.3 模块入口数组 (Module Entry Array)

```c
// init.c:15-20
static const struct kprobe_initcall *__mod_entry[] =
{
    &KPROBE_CALL(trace),         // 1. 通信子系统（最先初始化）
    &KPROBE_CALL(anti_rootkit),  // 2. 反 Rootkit 子系统
    &KPROBE_CALL(kprobe_hook),   // 3. Hook 子系统（最后初始化）
};

// 初始化顺序的重要性：
// 1. trace 必须最先初始化，因为它提供环形缓冲区
// 2. kprobe_hook 必须最后初始化，因为它依赖缓冲区
// 3. 错误处理按相反顺序清理（LIFO）
```

---

## 3. 数据流详解 (Data Flow Details)

### 3.1 完整数据流图 (Complete Data Flow)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           数据采集与传输流程                                │
└────────────────────────────────────────────────────────────────────────────┘

  [1] HOOK TRIGGER
       │
       │ 内核函数被调用 (如 do_sys_open, do_execve, connect 等)
       │
       ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  [2] KPROBE/KRETPROBE CALLBACK (smith_hook.c)                               │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ KPROBE_HANDLER_DEFINE3(do_sys_open, df, at, flags)                   │  │
│  │ {                                                                     │  │
│  │     // 1. 从寄存器/栈读取参数                                          │  │
│  │     // 2. 获取进程上下文信息 (pid, uid, exe_path 等)                  │  │
│  │     // 3. 检查白名单过滤                                               │  │
│  │     if (execve_exe_check(exe_path, len))                              │  │
│  │         return;  // 在白名单中，跳过                                   │  │
│  │                                                                       │  │
│  │     // 4. 预留环形缓冲区空间                                           │  │
│  │     event = trace_reserve(len);                                       │  │
│  │     if (!event)                                                        │  │
│  │         return;  // 缓冲区满，丢弃                                     │  │
│  │                                                                       │  │
│  │     // 5. 格式化事件数据                                               │  │
│  │     print_event_do_sys_open(event, ...);                              │  │
│  │                                                                       │  │
│  │     // 6. 提交事件到环形缓冲区                                         │  │
│  │     trace_commit(event);                                              │  │
│  │ }                                                                     │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  [3] PER-CPU RING BUFFER (trace_buffer.c)                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐                      │  │
│  │  │CPU0    │  │CPU1    │  │CPU2    │  │CPUN    │  无锁设计            │  │
│  │  │Buffer  │  │Buffer  │  │Buffer  │  │Buffer  │  每个CPU独立缓冲区    │  │
│  │  │        │  │        │  │        │  │        │  避免锁竞争          │  │
│  │  └────────┘  └────────┘  └────────┘  └────────┘                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  [4] TRACE SUBSYSTEM (trace.c) - 读取与格式化                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ trace_read_pipe()                                                    │  │
│  │ {                                                                    │  │
│  │     // 1. 从各 CPU 环形缓冲区读取事件                                  │  │
│  │     while (trace_next_entry_inc(iter) != NULL) {                     │  │
│  │         // 2. 查找事件格式化函数                                       │  │
│  │         class = find_print_event(entry->id);                         │  │
│  │         // 3. 格式化输出                                              │  │
│  │         class->format(seq, entry);                                   │  │
│  │         // 4. 标记事件已消费                                          │  │
│  │         tb_consume(iter->ring, iter->cpu, ...);                      │  │
│  │     }                                                                │  │
│  │ }                                                                    │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  [5] PROC FILESYSTEM INTERFACE                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  /proc/elkeid-endpoint (只读)                                         │  │
│  │                                                                       │  │
│  │  用户空间通过 read() 系统调用读取事件                                  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  [6] USER SPACE - Elkeid Agent                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  driver plugin 读取数据                                               │  │
│  │  │                                                                    │  │
│  │  ▼                                                                    │  │
│  │  数据解析 (按 \x17 和 \x1e 分隔符分割)                                 │  │
│  │  │                                                                    │  │
│  │  ▼                                                                    │  │
│  │  字段提取 (data_type, timestamp, pid, uid 等)                         │  │
│  │  │                                                                    │  │
│  │  ▼                                                                    │  │
│  │  上报到服务端 / 本地分析                                               │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 数据格式详解 (Data Format Details)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                          单个事件数据格式                                   │
└────────────────────────────────────────────────────────────────────────────┘

字段分隔符: \x17 (ASCII 23, End of Transmission Block)
记录分隔符: \x1e (ASCII 30, Record Separator)

┌──────────────────────────────────────────────────────────────────────────┐
│ 通用字段 (13个) - 所有事件类型都有                                        │
├──────────────────────────────────────────────────────────────────────────┤
│ 1. data_type       │ 事件类型 ID (1-612, 700-703)                       │
│ 2. timestamp       │ 纳秒级时间戳                                        │
│ 3. uid             │ 用户 ID                                            │
│ 4. gid             │ 组 ID                                              │
│ 5. pid             │ 进程 ID                                            │
│ 6. tid             │ 线程 ID                                            │
│ 7. session_id      │ 会话 ID                                            │
│ 8. ppid            │ 父进程 ID                                          │
│ 9. namespace       │ 容器 namespace 信息                                 │
│ 10. container_id   │ 容器 ID                                            │
│ 11. exe_path       │ 可执行文件路径                                      │
│ 12. cmdline        │ 命令行参数                                          │
│ 13. cwd            │ 当前工作目录                                        │
├──────────────────────────────────────────────────────────────────────────┤
│ 私有字段 - 根据事件类型不同而不同                                          │
├──────────────────────────────────────────────────────────────────────────┤
│ 例如: do_sys_open 事件                                                    │
│   - filename       │ 文件名                                              │
│   - flags          │ 打开标志                                            │
│   - mode           │ 权限模式                                            │
│   - return_value   │ 返回值 (文件描述符或错误码)                          │
└──────────────────────────────────────────────────────────────────────────┘

示例数据流:
100\x1717000000000\x170\x170\x1712345\x1712345\x170\x170\x170\x170\x17/usr/bin/ls\x17ls -la\x17/home/user\x17/tmp/test.txt\x17O_RDWR\x170\x176
\x1e
│   │     │      │   │    │     │      │    │    │    │    │         │        │      │         │    │    │
│   │     │      │   │    │     │      │    │    │    │    │         │        │      │         │    │    └─ 记录分隔符
│   │     │      │   │    │     │      │    │    │    │    │         │        │      │         │    └────── 返回值
│   │     │      │   │    │     │      │    │    │    │    │         │        │      │         └─────────── mode
│   │     │      │   │    │     │      │    │    │    │    │         │        │      └─────────────────── flags
│   │     │      │   │    │     │      │    │    │    │    │         │        └───────────────────────── filename
│   │     │      │   │    │     │      │    │    │    │    │         └────────────────────────────────── cwd
│   │     │      │   │    │     │      │    │    │    │    └─────────────────────────────────────────── cmdline
│   │     │      │   │    │     │      │    │    │    └──────────────────────────────────────────────── exe_path
│   │     │      │   │    │     │      │    │    └─────────────────────────────────────────────────── container_id
│   │     │      │   │    │     │      │    └────────────────────────────────────────────────────────── namespace
│   │     │      │   │    │     │      └─────────────────────────────────────────────────────────────── ppid
│   │     │      │   │    │     └────────────────────────────────────────────────────────────────────── session_id
│   │     │      │   │    └─────────────────────────────────────────────────────────────────────────── tid
│   │     │      │   └──────────────────────────────────────────────────────────────────────────────── pid
│   │     │      └─────────────────────────────────────────────────────────────────────────────────── gid
│   │     └─────────────────────────────────────────────────────────────────────────────────────────── uid
│   └────────────────────────────────────────────────────────────────────────────────────────────────── timestamp
└────────────────────────────────────────────────────────────────────────────────────────────────────── data_type (100 = execve)
```

---

## 4. 通信通道 (Communication Channels)

### 4.1 双通道架构 (Dual Channel Architecture)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         用户空间与内核空间通信                              │
└────────────────────────────────────────────────────────────────────────────┘

                        内核空间 (Kernel Space)
                               │
        ┌──────────────────────┴──────────────────────┐
        │                                             │
        ▼                                             ▼
┌──────────────────────┐                   ┌──────────────────────┐
│  数据流通道           │                   │  配置通道             │
│  Data Channel        │                   │  Config Channel      │
├──────────────────────┤                   ├──────────────────────┤
│ /proc/elkeid-endpoint│                   │/dev/hids_driver_     │
│                      │                   │     allowlist        │
├──────────────────────┤                   ├──────────────────────┤
│ • 只读 (Read-only)   │                   │ • 只写 (Write-only)  │
│ • 单向数据输出        │                   │ • 单向配置输入        │
│ • 事件数据流          │                   │ • 白名单配置          │
│ • 非阻塞/阻塞读取     │                   │ • 控制命令            │
└──────────────────────┘                   └──────────────────────┘
        │                                             │
        ▼                                             ▼
┌──────────────────────┐                   ┌──────────────────────┐
│ 用户空间读取          │                   │ 用户空间写入          │
│ • Agent plugin       │                   │ • Agent plugin       │
│ • cat /proc/...      │                   │ • echo "Y/path" >... │
└──────────────────────┘                   └──────────────────────┘
```

### 4.2 数据通道详细流程 (Data Channel Details)

```
用户空间                          内核空间
────────                          ────────

   │                                  │
   │  read()                          │
   │ ────────────────────────────────▶│
   │                                  │ ┌─────────────────────────┐
   │                                  │ │ trace_read_pipe()       │
   │                                  │ │ 1. 检查环形缓冲区是否空  │
   │                                  │ │ 2. 如果空且非阻塞模式   │
   │                                  │ │    返回 -EAGAIN         │
   │                                  │ │ 3. 如果空且阻塞模式     │
   │                                  │ │    等待数据到达         │
   │                                  │ └─────────────────────────┘
   │                                  │
   │                                  ▼
   │                         ┌─────────────────────┐
   │                         │ tb_wait()           │
   │                         │ 等待任意 CPU 有数据  │
   │                         └─────────────────────┘
   │                                  │
   │                                  ▼
   │                         ┌──────────────────────┐
   │                         │ __find_next_entry()  │
   │                         │ 从所有 CPU 中查找     │
   │                         │ 时间戳最小的事件      │
   │                         └──────────────────────┘
   │                                  │
   │                                  ▼
   │                         ┌──────────────────────┐
   │                         │ print_trace_fmt_line │
   │                         │ 格式化事件数据        │
   │                         └──────────────────────┘
   │                                  │
   │ ◀────────────────────────────────│
   │  返回格式化数据                   │
   │                                  │
   ▼                                  │
处理数据                              │
│                                    │
│  1. 按 \x17 分割字段                │
│  2. 按 \x1e 分割记录                │
│  3. 解析各个字段                    │
│                                    │
▼                                    │
发送到服务端/本地分析                 │
                                    │
```

### 4.3 配置通道详细流程 (Config Channel Details)

```
用户空间                          内核空间
────────                          ────────

   │                                  │
   │  echo "Y/usr/bin/ssh"            │
   │  write()                         │
   │ ────────────────────────────────▶│
   │                                  │ ┌─────────────────────────┐
   │                                  │ │ device_write()          │
   │                                  │ │ filter_process_         │
   │                                  │ │   allowlist()           │
   │                                  │ └─────────────────────────┘
   │                                  │
   │                                  ▼
   │                         ┌──────────────────────┐
   │                         │ 解析命令              │
   │                         │ flag = 第一个字节     │
   │                         │ data = 剩余数据       │
   │                         └──────────────────────┘
   │                                  │
   │              ┌───────────────────┴───────────────────┐
   │              ▼                   ▼                     ▼
   │      ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │      │ Y (添加)     │     │ D (删除)     │     │ w (清空)     │
   │      │ exe 白名单   │     │ exe 白名单   │     │ 所有白名单   │
   │      └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
   │             │                   │                   │
   │             ▼                   ▼                   ▼
   │    ┌─────────────────────────────────────────────┐
   │    │  操作红黑树                                   │
   │    │  insert_rb() / search_rb() / rb_erase()     │
   │    └─────────────────────────────────────────────┘
   │                                  │
   │ ◀────────────────────────────────│
   │  返回写入字节数                   │
   │                                  │
```

### 4.4 白名单命令格式 (Allowlist Command Format)

```
命令格式: <flag><data>

示例:
  Y/usr/bin/ssh       - 添加 /usr/bin/ssh 到 execve exe 白名单
  N/tmp/malware       - 添加 /tmp/malware 到黑名单（预留）
  D/usr/bin/ssh       - 从白名单删除 /usr/bin/ssh
  w                   - 清空所有白名单
  y/path/to/exe       - 检查路径是否在白名单中
  .                   - 打印所有白名单
  m-ssh               - 添加 "-ssh" 到 argv 白名单
  J-ssh               - 从 argv 白名单删除 "-ssh"
  u                   - 清空所有 argv 白名单

Flag 定义 (filter.c:25-36):
  Y (89) - ADD_EXECVE_EXE_ALLOWLIST
  F (70) - DEL_EXECVE_EXE_ALLOWLIST
  w (119) - DEL_ALL_EXECVE_EXE_ALLOWLIST
  y (121) - EXECVE_EXE_CHECK
  . (46) - PRINT_ALL_ALLOWLIST
  m (109) - ADD_EXECVE_ARGV_ALLOWLIST
  J (74) - DEL_EXECVE_ARGV_ALLOWLIST
  u (117) - DEL_ALL_EXECVE_ARGV_ALLOWLIST
  z (122) - EXECVE_ARGV_CHECK
```

---

## 5. 核心组件详解 (Core Components)

### 5.1 Kprobe Hook 子系统 (smith_hook.c)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         Kprobe Hook Subsystem                               │
│                        smith_hook.c (5,101 行)                              │
└────────────────────────────────────────────────────────────────────────────┘

                           ┌─────────────────┐
                           │ smith_hook_init │
                           └────────┬────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────┐       ┌───────────────┐       ┌───────────────┐
    │ Kprobe 注册   │       │ Kretprobe 注册│       │ Tracepoint 注册│
    └───────┬───────┘       └───────┬───────┘       └───────┬───────┘
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────┐       ┌───────────────┐       ┌───────────────┐
    │ 函数入口钩子   │       │ 函数返回钩子   │       │ 静态跟踪点     │
    │ • do_sys_open │       │ • do_sys_open │       │ • sys_enter   │
    │ • do_execve   │       │ • do_execve   │       │ • sys_exit    │
    │ • connect     │       │ • connect     │       │ • sched_      │
    │ • bind        │       │ • bind        │       │   switch      │
    │ • ...         │       │ • ...         │       │ • ...         │
    └───────┬───────┘       └───────┬───────┘       └───────┬───────┘
            │                       │                       │
            └───────────────────────┼───────────────────────┘
                                    │
                                    ▼
                           ┌─────────────────┐
                           │  数据收集与      │
                           │  格式化输出      │
                           └─────────────────┘
```

### 5.2 环形缓冲区 (trace_buffer.c)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    Per-CPU Ring Buffer Architecture                         │
│                   trace_buffer.c (4,376 行)                                 │
└────────────────────────────────────────────────────────────────────────────┘

                    无锁设计 (Lock-free Design)

  ┌────────────────────────────────────────────────────────────────────┐
  │                         tb_ring                                     │
  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐     │
  │  │ CPU 0  │  │ CPU 1  │  │ CPU 2  │  │ CPU 3  │  │ CPU N  │     │
  │  │        │  │        │  │        │  │        │  │        │     │
  │  │ ┌────┐ │  │ ┌────┐ │  │ ┌────┐ │  │ ┌────┐ │  │ ┌────┐ │     │
  │  │ │HEAD│ │  │ │HEAD│ │  │ │HEAD│ │  │ │HEAD│ │  │ │HEAD│ │     │
  │  │ ▼    │ │  │ ▼    │ │  │ ▼    │ │  │ ▼    │ │  │ ▼    │ │     │
  │  │ ┌────┐ │  │ ┌────┐ │  │ ┌────┐ │  │ ┌────┐ │  │ ┌────┐ │     │
  │  │ │    │ │  │ │    │ │  │ │    │ │  │ │    │ │  │ │    │ │     │
  │  │ │E1  │ │  │ │E5  │ │  │ │E9  │ │  │ │E13 │ │  │ │E17 │ │     │
  │  │ │E2  │ │  │ │E6  │ │  │ │E10 │ │  │ │    │ │  │ │    │ │     │
  │  │ │E3  │ │  │ │E7  │ │  │ │E11 │ │  │ │    │ │  │ │    │ │     │
  │  │ │E4  │ │  │ │E8  │ │  │ │E12 │ │  │ │    │ │  │ │    │ │     │
  │  │ │    │ │  │ │    │ │  │ │    │ │  │ │    │ │  │ │    │ │     │
  │  │ └────┘ │  │ └────┘ │  │ └────┘ │  │ └────┘ │  │ └────┘ │     │
  │  │   ▲    │  │   ▲    │  │   ▲    │  │   ▲    │  │   ▲    │     │
  │  │ │TAIL│ │  │ │TAIL│ │  │ │TAIL│ │  │ │TAIL│ │  │ │TAIL│ │     │
  │  │ └────┘ │  │ └────┘ │  │ └────┘ │  │ └────┘ │  │ └────┘ │     │
  │  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘     │
  └────────────────────────────────────────────────────────────────────┘

  HEAD - 写入位置 (Producer 指针)
  TAIL - 读取位置 (Consumer 指针)

  特性:
  • Per-CPU 隔离 - 每个 CPU 有独立缓冲区
  • 无锁写入 - Producer 只操作本 CPU 的 HEAD
  • 无锁读取 - Consumer 循环读取所有 CPU
  • 时间排序 - 按 timestamp 排序多 CPU 事件
  • 覆盖模式 - 缓冲区满时覆盖最旧事件
```

### 5.3 白名单过滤系统 (filter.c)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                       Allowlist Filtering System                            │
│                         filter.c (578 行)                                   │
└────────────────────────────────────────────────────────────────────────────┘

                              ┌────────────┐
                              │ 用户空间写入 │
                              │ allowlist   │
                              └──────┬─────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ filter_process_ │
                            │   allowlist()   │
                            └────────┬────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    ▼                                 ▼
          ┌──────────────────┐             ┌──────────────────┐
          │  EXE 白名单        │             │  ARGV 白名单       │
          │  (execve_exe)     │             │  (execve_argv)    │
          └────────┬─────────┘             └────────┬─────────┘
                   │                                 │
                   ▼                                 ▼
          ┌──────────────────┐             ┌──────────────────┐
          │  Red-Black Tree   │             │  Red-Black Tree   │
          │  (红黑树)          │             │  (红黑树)          │
          │                   │             │                   │
          │  • O(log n) 查找  │             │  • O(log n) 查找  │
          │  • Hash 索引      │             │  • Hash 索引      │
          │  • 读写锁保护      │             │  • 读写锁保护      │
          └────────┬─────────┘             └────────┬─────────┘
                   │                                 │
                   │        Hook 触发时检查            │
                   │◀────────────────────────────────│
                   │
                   ▼
          ┌──────────────────┐
          │ execve_exe_check │
          │ execve_argv_check│
          └────────┬─────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    在白名单中        不在白名单中
          │                 │
          ▼                 ▼
    跳过采集          采集事件
```

---

## 6. Hook 类型分类 (Hook Type Categories)

### 6.1 监控能力矩阵 (Monitoring Capabilities Matrix)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                          Hook Type Categories                               │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ 网络监控 (Network Monitoring)                                               │
├────────────────────────────────────────────────────────────────────────────┤
│ ID  │ Hook            │ 描述                                                │
├─────┼─────────────────┼────────────────────────────────────────────────────┤
│ 400 │ connect         │ TCP/UDP 连接建立                                    │
│ 401 │ bind            │ 端口绑定                                            │
│ 402 │ accept          │ 接受连接                                            │
│ 403 │ listen          │ 监听端口                                            │
│ 404 │ dns_query       │ DNS 查询 (udp_sndmsg)                               │
│ 405 │ dns_response    │ DNS 响应 (udp_rcv)                                  │
└─────┴─────────────────┴────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ 进程监控 (Process Monitoring)                                               │
├────────────────────────────────────────────────────────────────────────────┤
│ ID  │ Hook            │ 描述                                                │
├─────┼─────────────────┼────────────────────────────────────────────────────┤
│ 100 │ execve          │ 进程执行                                            │
│ 101 │ exit            │ 进程退出                                            │
│ 102 │ kill            │ 进程信号                                            │
│ 103 │ ptrace          │ 调试器附加                                          │
│ 104 │ fork            │ 进程创建 (do_fork)                                  │
│ 105 │ prctl           │ 进程控制操作                                        │
└─────┴─────────────────┴────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ 文件操作 (File Operations)                                                  │
├────────────────────────────────────────────────────────────────────────────┤
│ ID  │ Hook            │ 描述                                                │
├─────┼─────────────────┼────────────────────────────────────────────────────┤
│ 1   │ do_sys_open     │ 文件打开                                            │
│ 2   │ do_sys_openat   │ 文件打开 (相对路径)                                 │
│ 3   │ write           │ 文件写入                                            │
│ 4   │ writev          │ 向量写入                                            │
│ 5   │ rename          │ 文件重命名                                          │
│ 6   │ link            │ 硬链接创建                                          │
│ 7   │ symlink         │ 软链接创建                                          │
│ 8   │ unlink          │ 文件删除                                            │
└─────┴─────────────────┴────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ 安全相关 (Security Related)                                                 │
├────────────────────────────────────────────────────────────────────────────┤
│ ID  │ Hook            │ 描述                                                │
├─────┼─────────────────┼────────────────────────────────────────────────────┤
│ 500 │ cred_change     │ 凭证变更                                            │
│ 501 │ cap_raised      │ 能力提升                                            │
│ 502 │ module_load     │ 内核模块加载                                        │
│ 503 │ module_request  │ 模块请求                                            │
└─────┴─────────────────┴────────────────────────────────────────────────────┘
```

---

## 7. 性能与优化 (Performance & Optimization)

### 7.1 性能优化技术 (Performance Optimization Techniques)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         Performance Optimizations                          │
└────────────────────────────────────────────────────────────────────────────┘

1. Per-CPU 设计
   • 每个 CPU 独立缓冲区
   • 避免跨 CPU 的锁竞争
   • 无锁写入路径

2. 原子上下文优化
   • 使用 GFP_ATOMIC 内存分配
   • 预分配内存池 (memcache.c)
   • 避免睡眠操作

3. 白名单过滤
   • Hook 回调中早期检查
   • 减少不必要的数据采集
   • 红黑树 O(log n) 查找

4. 批量读取
   • 用户空间批量读取多个事件
   • 减少系统调用次数

5. 时间戳优化
   • 使用 fast time stamps
   • 时间增量编码

性能指标:
  • TP99 延迟: < 3.5us
  • 缓冲区大小: 每个 CPU 4MB (可配置)
  • 最大事件大小: ~4KB
```

---

## 8. 容器支持 (Container Support)

### 8.1 Namespace 感知 (Namespace Awareness)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         Container Support                                   │
└────────────────────────────────────────────────────────────────────────────┘

每个事件包含 Namespace 信息:
  • PID Namespace - 进程 ID 命名空间
  • Mount Namespace - 挂载点命名空间
  • Network Namespace - 网络命名空间
  • UTS Namespace - 主机名命名空间
  • User Namespace - 用户命名空间

容器检测流程:
  1. 读取当前进程的 namespace 信息
  2. 与 init 进程 (PID 1) 的 namespace 比较
  3. 如果不同，则进程在容器内
  4. 记录 container_id

示例:
  主机进程: namespace = "host" / container_id = ""
  容器进程: namespace = "c-12345" / container_id = "docker:abc123"
```

---

## 9. 文件依赖关系 (File Dependencies)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         File Dependency Graph                               │
└────────────────────────────────────────────────────────────────────────────┘

init.c
  │
  ├── kprobe.h
  │
  ├── trace.c ──┬──► trace.h
  │             ├──► trace_buffer.h ──► trace_buffer.c
  │             ├──► filter.h ────────► filter.c
  │             └──► kprobe.h
  │
  ├── anti_rootkit.c ──► anti_rootkit.h
  │
  └── smith_hook.c ──► smith_hook.h
                       ├──► kprobe.h
                       ├──► trace.h
                       ├──► filter.h
                       └──► print_event.h

头文件依赖:
  kprobe.h          - Kprobe 宏模板
  smith_hook.h      - Hook 定义和内核兼容性
  trace.h           - Trace 事件定义
  trace_buffer.h    - 环形缓冲区 API
  filter.h          - 白名单过滤 API
  print_event.h     - 事件打印宏
  anti_rootkit.h    - 反 Rootkit API
  util.h            - 工具函数
  memcache.h        - 内存池 API
```

---

## 10. 总结 (Summary)

### 关键设计原则

1. **模块化** - 三大独立子系统，便于维护和扩展
2. **高性能** - Per-CPU 无锁设计，TP99 < 3.5us
3. **可配置** - 白名单系统，支持动态配置
4. **兼容性** - 支持内核 2.6.32 - 6.3，多架构
5. **安全** - 内核级监控，难以绕过

### 下一步学习

- 阅读 `LEARNING_PATH.md` 获取详细学习计划
- 阅读 `KPROBE.md` 学习 Kprobe 使用
- 阅读 `DATA_FLOW.md` 深入理解数据流
- 阅读 `README.md` 获取完整文档

---

**文档版本**: 1.0
**最后更新**: 2024
**维护者**: Elkeid Team
