# Elkeid Server 端整体架构分析

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Elkeid Server 架构                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Web Console (前端)                                  │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│                                        │ HTTP (REST API)                              │
│                                        ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Manager 集群                                         │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │ │
│  │  │  Manager-1  │    │  Manager-2  │    │  Manager-3  │    │    ...      │       │ │
│  │  │             │◄──►│             │◄──►│             │◄──►│             │       │ │
│  │  │  API 服务   │    │  API 服务   │    │  API 服务   │    │  API 服务   │       │ │
│  │  │  分布式任务 │    │  分布式任务 │    │  分布式任务 │    │  分布式任务 │       │ │
│  │  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘       │ │
│  │         └──────────────────┼──────────────────┼──────────────────┘              │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│           ┌────────────────────────────┼────────────────────────────┐                │
│           │                            │                            │                │
│           ▼                            ▼                            ▼                │
│  ┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐        │
│  │   MongoDB       │         │     Redis       │         │     Kafka       │        │
│  │   (数据存储)    │         │  (缓存/任务)    │         │   (消息队列)    │        │
│  └─────────────────┘         └─────────────────┘         └─────────────────┘        │
│                                        │                            ▲                │
│                                        │                            │                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           AgentCenter 集群                                        │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │ │
│  │  │    AC-1     │    │    AC-2     │    │    AC-3     │    │    ...      │       │ │
│  │  │             │    │             │    │             │    │             │       │ │
│  │  │ gRPC 服务   │    │ gRPC 服务   │    │ gRPC 服务   │    │ gRPC 服务   │       │ │
│  │  │ 连接池管理  │    │ 连接池管理  │    │ 连接池管理  │    │ 连接池管理  │       │ │
│  │  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘       │ │
│  │         └──────────────────┴──────────────────┴──────────────────┘              │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│                                        │ gRPC (mTLS)                                  │
│                                        ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              ServiceDiscovery 集群                                │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                          │ │
│  │  │    SD-1     │◄──►│    SD-2     │◄──►│    SD-3     │                          │ │
│  │  │             │sync│             │sync│             │                          │ │
│  │  │  注册中心   │    │  注册中心   │    │  注册中心   │                          │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                          │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        ▲                                              │
│                                        │ HTTP (服务注册/发现)                         │
│                                        │                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                  Agents                                           │ │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐              │ │
│  │  │Agent-1 │ │Agent-2 │ │Agent-3 │ │Agent-4 │ │Agent-5 │ │ ...    │              │ │
│  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘              │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 组件职责

| 组件 | 代码量 | 主要职责 | 通信协议 |
|------|--------|----------|----------|
| **ServiceDiscovery** | ~1,251 行 | 服务注册发现、负载均衡 | HTTP |
| **AgentCenter** | ~8,188 行 | Agent 通信、数据采集、命令下发 | gRPC + HTTP |
| **Manager** | ~25,000+ 行 | 后台管理、API 服务、分布式任务 | HTTP |

---

## 3. 服务依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                     服务依赖图                               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│   ServiceDiscovery (SD)                                       │
│        ▲                                                      │
│        │ 注册                                                 │
│   ┌────┴────┬────────────┐                                   │
│   │         │            │                                    │
│   │  AgentCenter (AC)    │                                    │
│   │         │            │                                    │
│   │    ┌────┘            │                                    │
│   │    │  命令/配置      │                                    │
│   │    ▼                 │                                    │
│   │  Manager (MG)   ─────┘                                    │
│   │         │                                                 │
│   │         │ 数据                                            │
│   │    ┌────┴────┬────────────┐                              │
│   │    ▼         ▼            ▼                               │
│   │ MongoDB    Redis       Kafka                              │
│   │                                                           │
│   └─────────────────────────────────────────────────────────  │
│                                                               │
│   Agent                                                       │
│     │                                                         │
│     ├─ GET SD 获取 AC 列表                                    │
│     ├─ gRPC 连接 AC (负载最低的)                              │
│     └─ 上报数据 / 接收命令                                    │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 通信模式

### 4.1 Agent → Server 数据上报

```
Agent
  │
  │ 1. GET http://{SD}/registry/detail?name=ac_grpc
  │    获取 AgentCenter 列表
  ▼
ServiceDiscovery
  │
  │ 返回 AC 列表 (按权重排序)
  ▼
Agent
  │
  │ 2. 选择权重最低的 AC
  │    建立 gRPC 双向流连接 (mTLS)
  ▼
AgentCenter
  │
  │ 3. 接收 Agent 数据
  │    ├─ 心跳 (DataType=1000/1001)
  │    ├─ 资产 (DataType=5050-5062)
  │    ├─ 告警 (DataType=2001/2003)
  │    └─ 任务结果 (DataType=5100/6000)
  │
  │ 4. 写入 Kafka
  ▼
Kafka
  │
  │ 5. 消费数据
  ▼
Manager / HubManager
  │
  │ 6. 存储到 MongoDB
  ▼
MongoDB
```

### 4.2 Server → Agent 命令下发

```
Web Console / API
  │
  │ 1. POST /api/v6/agent/createAgentTask
  ▼
Manager
  │
  │ 2. 创建任务记录 (MongoDB)
  │    获取目标 Agent 所在的 AC
  │
  │ 3. POST http://{AC}/command/
  ▼
AgentCenter
  │
  │ 4. 通过 GRPCPool 找到 Agent 连接
  │    发送命令到 CommandChan
  │
  │ 5. sendData 协程发送到 Agent
  ▼
Agent
  │
  │ 6. 执行命令
  │    上报执行结果
  ▼
AgentCenter → Kafka → Manager → MongoDB
```

### 4.3 服务注册与发现

```
服务启动
  │
  │ 1. POST http://{SD}/registry/register
  │    ├─ name: "ac_grpc" / "ac_http" / "manager_http"
  │    ├─ ip: 服务 IP
  │    ├─ port: 服务端口
  │    └─ weight: 当前负载
  ▼
ServiceDiscovery
  │
  │ 2. 存储到 registryMap
  │    同步到其他 SD 节点
  │
  │ 3. 定时心跳 (每30秒)
  │    更新 weight (AC: 连接数)
  ▼
Agent / 其他服务
  │
  │ 4. GET http://{SD}/registry/detail?name={svrName}
  │    获取服务列表
  ▼
ServiceDiscovery
  │
  │ 5. 返回服务列表 (按权重排序)
  │    Fetch 算法: min/max/random
  ▼
调用方选择合适的服务实例
```

---

## 5. 配置同步流程

```
配置变更 (Web Console)
  │
  │ 1. POST /api/v6/component/PublishComponentVersion
  ▼
Manager
  │
  │ 2. 更新 MongoDB (component_policy)
  │    触发配置同步任务
  │
  │ 3. 分布式任务分发 (Redis Pub/Sub)
  ▼
Manager 集群
  │
  │ 4. 各 Manager 调用 AC HTTP API
  │    POST http://{AC}/command/
  │    ├─ agent_id: 目标 Agent
  │    └─ command.config: 新配置
  ▼
AgentCenter 集群
  │
  │ 5. 通过 gRPC 流发送配置
  ▼
Agent
  │
  │ 6. 接收配置
  │    ├─ 比对版本
  │    ├─ 下载插件
  │    └─ 加载/卸载/更新
  │
  │ 7. 上报执行结果
  ▼
AgentCenter → Kafka → Manager
  │
  │ 8. 更新任务状态 (MongoDB)
  ▼
Web Console 展示结果
```

---

## 6. 安全架构

### 6.1 通信安全

| 通信路径 | 协议 | 认证方式 |
|----------|------|----------|
| Agent ↔ AC | gRPC | mTLS (双向证书) |
| AC ↔ SD | HTTP | AK/SK 签名 |
| AC ↔ Manager | HTTP | 无 (内网) |
| Manager ↔ SD | HTTP | AK/SK 签名 |
| Console ↔ Manager | HTTP | JWT/Session + RBAC |
| Manager ↔ Manager | HTTP | AK/SK 签名 |

### 6.2 认证层级

```
┌─────────────────────────────────────────────────────────────┐
│                    安全认证层级                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  层级 1: 传输层 (TLS/mTLS)                                   │
│    ├─ Agent ↔ AC: 双向 TLS 证书验证                          │
│    └─ 其他: 可选 HTTPS                                       │
│                                                               │
│  层级 2: 服务层 (AK/SK)                                      │
│    ├─ HMAC-SHA256 签名                                       │
│    ├─ 时间戳防重放 (±60秒)                                   │
│    └─ 用于服务间通信                                         │
│                                                               │
│  层级 3: 应用层 (JWT/Session)                                │
│    ├─ JWT: 12小时过期                                        │
│    ├─ Session: Redis 存储                                    │
│    └─ 用于 Console API                                       │
│                                                               │
│  层级 4: 权限层 (RBAC)                                       │
│    ├─ 基于角色的访问控制                                     │
│    ├─ 路径+方法匹配规则                                      │
│    └─ rbac.json 配置                                         │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 证书管理

```
CA 根证书 (ca.crt)
  │
  ├─ Server 证书 (用于 AC)
  │   ├─ server.crt
  │   └─ server.key
  │
  └─ Client 证书 (嵌入 Agent)
      ├─ client.crt
      └─ client.key
```

---

## 7. 高可用设计

### 7.1 ServiceDiscovery 高可用

```
┌─────────────────────────────────────────────────────────────┐
│                   SD 高可用设计                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  多节点部署:                                                  │
│    ├─ 每个节点独立提供服务                                   │
│    ├─ 注册操作实时同步                                       │
│    └─ 任意节点可查询                                         │
│                                                               │
│  健康检查:                                                    │
│    ├─ 5级状态渐进降级                                        │
│    ├─ Green→Blue→Yellow→Orange→Red                          │
│    └─ 超过105秒自动剔除                                      │
│                                                               │
│  配置热加载:                                                  │
│    ├─ fsnotify 监控配置文件                                  │
│    └─ 自动更新集群成员                                       │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 AgentCenter 高可用

```
┌─────────────────────────────────────────────────────────────┐
│                   AC 高可用设计                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  负载均衡:                                                    │
│    ├─ 向 SD 注册时上报当前连接数                             │
│    ├─ Agent 选择负载最低的 AC                                │
│    └─ 连接数动态更新 (每30秒)                                │
│                                                               │
│  连接限流:                                                    │
│    ├─ Token 令牌池控制最大连接                               │
│    ├─ 超出限制返回错误                                       │
│    └─ Agent 自动重连其他 AC                                  │
│                                                               │
│  容错机制:                                                    │
│    ├─ gRPC 双向流独立处理                                    │
│    ├─ 任一方向错误触发重连                                   │
│    └─ Kafka 异步写入                                         │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 Manager 高可用

```
┌─────────────────────────────────────────────────────────────┐
│                   Manager 高可用设计                         │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  无状态设计:                                                  │
│    ├─ Session 存储在 Redis                                   │
│    ├─ 任务状态存储在 Redis                                   │
│    └─ 数据存储在 MongoDB                                     │
│                                                               │
│  分布式任务:                                                  │
│    ├─ Redis Pub/Sub 任务分发                                 │
│    ├─ SetNX 分布式锁                                         │
│    └─ 任务同步到所有节点                                     │
│                                                               │
│  故障恢复:                                                    │
│    ├─ 任务失败自动重试                                       │
│    ├─ Job 超时自动终止                                       │
│    └─ 分布式锁自动过期                                       │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 数据存储架构

### 8.1 存储分层

```
┌─────────────────────────────────────────────────────────────┐
│                    数据存储分层                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  热数据层 (Redis):                                           │
│    ├─ Session 会话                                           │
│    ├─ 分布式锁                                               │
│    ├─ 分布式任务                                             │
│    ├─ Agent 在线列表                                         │
│    └─ 配置缓存                                               │
│                                                               │
│  消息层 (Kafka):                                             │
│    ├─ Agent 采集数据                                         │
│    ├─ 告警数据                                               │
│    ├─ 资产数据                                               │
│    └─ 审计日志                                               │
│                                                               │
│  持久层 (MongoDB):                                           │
│    ├─ Agent 心跳                                             │
│    ├─ 告警记录                                               │
│    ├─ 漏洞信息                                               │
│    ├─ 基线结果                                               │
│    ├─ 资产指纹                                               │
│    ├─ 任务记录                                               │
│    └─ 用户信息                                               │
│                                                               │
│  归档层 (Elasticsearch) [可选]:                              │
│    ├─ 历史告警                                               │
│    └─ 操作日志                                               │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 数据流向

```
Agent 采集数据
  │
  │ gRPC
  ▼
AgentCenter
  │
  │ Protobuf 序列化
  ▼
Kafka (hids_topic)
  │
  ├─────────────────────────────┐
  │                             │
  ▼                             ▼
HubManager                   Manager
(告警处理)               (资产/任务处理)
  │                             │
  ▼                             ▼
MongoDB                     MongoDB
(hub_alarm_v1)          (agent_asset_*)
```

---

## 9. 可观测性

### 9.1 Prometheus 指标汇总

| 组件 | 指标前缀 | 主要指标 |
|------|----------|----------|
| SD | `elkeid_sd_` | HTTP API 计数、注册服务数 |
| AC | `elkeid_ac_` | gRPC 连接数、收发 QPS、Agent 资源 |
| Manager | `elkeid_manager_` | HTTP API 计数、Agent 数、告警数 |

### 9.2 日志体系

```
各组件日志:
  ├─ 位置: 配置文件指定
  ├─ 轮转: maxSize=10M, maxBackups=3, maxAge=3天
  ├─ 级别: Debug/Info/Warn/Error/Fatal
  └─ 格式: 结构化日志 (时间+级别+模块+消息)
```

---

## 10. 部署架构

### 10.1 最小部署

```
┌─────────────────────────────────────────────┐
│              单机部署 (开发/测试)            │
├─────────────────────────────────────────────┤
│                                               │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
│  │   SD    │  │   AC    │  │ Manager │      │
│  │ :8088   │  │ :6751   │  │ :6789   │      │
│  └─────────┘  │ :6752   │  └─────────┘      │
│               └─────────┘                    │
│                                               │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
│  │ MongoDB │  │  Redis  │  │  Kafka  │      │
│  │ :27017  │  │ :6379   │  │ :9092   │      │
│  └─────────┘  └─────────┘  └─────────┘      │
│                                               │
└─────────────────────────────────────────────┘
```

### 10.2 生产部署

```
┌─────────────────────────────────────────────────────────────┐
│                    生产高可用部署                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  负载均衡层:                                                  │
│    └─ Nginx / HAProxy / Cloud LB                             │
│                                                               │
│  服务层:                                                      │
│    ├─ SD × 3 (配置集群)                                      │
│    ├─ AC × N (按 Agent 数量扩展)                             │
│    └─ Manager × N (按请求量扩展)                             │
│                                                               │
│  中间件层:                                                    │
│    ├─ MongoDB 副本集 (1主2从)                                │
│    ├─ Redis 哨兵/集群                                        │
│    └─ Kafka 集群 (3+ broker)                                 │
│                                                               │
│  文件存储:                                                    │
│    └─ Nginx + CDN (组件下载)                                 │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 11. 容量规划

### 11.1 资源估算

| 组件 | Agent 规模 | CPU | 内存 | 磁盘 |
|------|------------|-----|------|------|
| SD × 3 | 任意 | 2C | 4G | 20G |
| AC × 1 | 10,000 | 4C | 8G | 50G |
| AC × 1 | 50,000 | 8C | 16G | 100G |
| Manager × 1 | 任意 | 4C | 8G | 50G |

### 11.2 扩容指南

| 瓶颈 | 解决方案 |
|------|----------|
| Agent 连接数 | 增加 AC 实例 |
| API 请求量 | 增加 Manager 实例 |
| Kafka 吞吐 | 增加分区数/Broker 数 |
| MongoDB 性能 | 分片集群 |
| Redis 性能 | Redis 集群 |

---

## 12. 关键配置项

### 12.1 ServiceDiscovery

```yaml
Server:
  Ip: "0.0.0.0"
  Port: 8088

Cluster:
  Mode: "config"
  Members:
    - "sd1:8088"
    - "sd2:8088"
    - "sd3:8088"

Auth:
  Enable: true
  Keys:
    your_ak: "your_sk"
```

### 12.2 AgentCenter

```yaml
server:
  grpc:
    port: 6751
    connlimit: 50000   # 最大 Agent 连接数
  http:
    port: 6752
  ssl:
    certfile: "cert/server.crt"
    keyfile: "cert/server.key"
    cafile: "cert/ca.crt"

sd:
  name: "ac"
  addrs:
    - "sd1:8088"
    - "sd2:8088"

kafka:
  addrs:
    - "kafka1:9092"
  topic: "hids_svr"
```

### 12.3 Manager

```yaml
http:
  port: 6789
  apiauth:
    enable: true
    secret: "your_jwt_secret"

sd:
  name: "manager"
  addrs:
    - "sd1:8088"

mongo:
  uri: "mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0"
  dbname: "elkeid_manager"

redis:
  addrs:
    - "redis1:6379"
  mastername: "mymaster"
```

---

## 总结

Elkeid Server 端采用**微服务架构**，由 3 个核心组件组成：

| 组件 | 代码量 | 核心功能 |
|------|--------|----------|
| **ServiceDiscovery** | ~1,251 行 | 服务注册发现、健康检查、负载均衡 |
| **AgentCenter** | ~8,188 行 | Agent 通信、数据采集、命令下发 |
| **Manager** | ~25,000+ 行 | API 服务、分布式任务、安全管理 |

**总计：约 34,439 行代码**

### 架构特点

1. **微服务分离** - 职责清晰，独立扩展
2. **无状态设计** - Session/任务存储在 Redis
3. **分布式任务** - Redis Pub/Sub + 分布式锁
4. **多层安全** - mTLS + AK/SK + JWT + RBAC
5. **高可用** - 多实例部署 + 自动故障恢复
6. **可观测** - Prometheus 指标 + 结构化日志
7. **弹性扩展** - 按需增加 AC/Manager 实例
